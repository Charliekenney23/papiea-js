<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-12-05 Wed 23:35 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Papiea Design</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Shlomi Vaknin" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/htmlize.css"/>
<link rel="stylesheet" type="text/css" href="https://fniessen.github.io/org-html-themes/styles/readtheorg/css/readtheorg.css"/>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/lib/js/jquery.stickytableheaders.min.js"></script>
<script type="text/javascript" src="https://fniessen.github.io/org-html-themes/styles/readtheorg/js/readtheorg.js"></script>
<style>pre.src{background:#343131;color:white;} </style>
<style>#content{max-width:70%;} </style>
<style>div > ol.org-ol > li {margin-bottom:5px !important; /*color:red !important*/} </style>
<style>.nav .timestamp {color: inherit;}</style>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        displayAlign: "left",
        displayIndent: "5em",

        "HTML-CSS": { scale: 100,
                        linebreaks: { automatic: "false" },
                        webFont: "Neo-Euler"
                       },
        SVG: {scale: 100,
              linebreaks: { automatic: "false" },
              font: "Neo-Euler"},
        NativeMML: {scale: 100},
        TeX: { equationNumbers: {autoNumber: "AMS"},
               MultLineWidth: "85%",
               TagSide: "left",
               TagIndent: ".8em"
             }
});
</script>
<script type="text/javascript"
        src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_HTML"></script>
</head>
<body>
<div id="content">
<h1 class="title">Papiea Design</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#h-A6599723-E88D-44A3-A967-AE0C49A54CC6">1. Definitions</a></li>
<li><a href="#h-CE2D607E-693A-4AEC-A492-4232FDFB9D78">2. Basic Interfaces</a>
<ul>
<li><a href="#h-CE60E8C5-765E-4454-A5F9-2780A2464889">2.1. Metadata</a></li>
<li><a href="#h-BAE5B042-453A-4E68-9829-DFEED95D9C4F">2.2. Spec</a></li>
<li><a href="#h-48BE09F4-1DFC-4110-9F9F-67399113C57C">2.3. Status</a></li>
<li><a href="#h-122002C8-E0B4-40F9-A48B-E75FDA28AAC6">2.4. Entity</a></li>
<li><a href="#h-1A45850B-821C-439F-BE1C-5CA5FF2B7A79">2.5. Kind</a></li>
<li><a href="#h-72D813C8-1AEE-449B-BE2E-0FB4FC53FD5A">2.6. Entity Reference</a></li>
<li><a href="#h-97314854-673B-4CD4-874A-B9C1F9AE6B44">2.7. Provider description</a></li>
</ul>
</li>
<li><a href="#h-855804C6-C489-4C0E-97BC-889C0D9634F2">3. Modules</a>
<ul>
<li><a href="#h-66558F55-8F93-44E5-9A37-0BD433627126">3.1. Databases</a>
<ul>
<li><a href="#h-9E8BF858-2CCE-4A4D-A786-ED53BA3F79E9">3.1.1. Status</a>
<ul>
<li><a href="#h-7E3D79F1-DC44-4C08-8EA0-CC683CEB36BA">3.1.1.1. Interface</a></li>
</ul>
</li>
<li><a href="#h-67BEA7CF-81F7-4C99-84AB-FC36B20906C6">3.1.2. Spec</a>
<ul>
<li><a href="#h-C485E97F-9BAD-4B12-820E-02E408231E6E">3.1.2.1. Interface</a></li>
</ul>
</li>
<li><a href="#h-8693B55A-1808-4981-B1E1-D07BFF286BD3">3.1.3. Providers</a>
<ul>
<li><a href="#h-48C4E5F4-E98F-4DAA-8DB7-1576C1EC3B09">3.1.3.1. Interface</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-DEA1F8F2-7248-4943-8B88-068C4D3207B5">3.2. Dependent services</a>
<ul>
<li><a href="#h-A0127E94-8730-4DC2-B3EA-93BEA06DE7F1">3.2.1. Tasks</a>
<ul>
<li><a href="#h-D04F146F-B16A-481B-9CD6-7552308467FF">3.2.1.1. Interface</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-2DAE1462-7E56-421D-8625-C24A3CF5E16F">3.3. Papiea Engine</a>
<ul>
<li><a href="#h-8A63D538-E97D-4CC4-B11D-18868DABE10B">3.3.1. Initialize</a>
<ul>
<li><a href="#h-3D76A395-5D87-495F-9138-9373F4CC859C">3.3.1.1. Interface</a></li>
<li><a href="#h-D2D67873-9F25-4339-9391-F10C5114F875">3.3.1.2. Pseudocode</a></li>
</ul>
</li>
<li><a href="#h-7899FFEB-F907-4103-B591-11240E8BF9DE">3.3.2. Exporting APIs</a>
<ul>
<li><a href="#h-D6CB7ACB-5E8E-4AC1-92BE-D35612E45558">3.3.2.1. Admin facing APIs</a>
<ul>
<li><a href="#h-CF1BC3A4-03DC-4305-ADFD-D8AADFEA0C2E">3.3.2.1.1. Pseudocode</a></li>
</ul>
</li>
<li><a href="#h-58B8746D-246B-437B-9457-04F667D64751">3.3.2.2. Provider facing APIs</a>
<ul>
<li><a href="#h-5256D1D9-391F-40C7-B090-EFC90473CDD0">3.3.2.2.1. Provider's SDK</a></li>
<li><a href="#h-3862D814-9E80-414B-B086-16A05A2710FE">3.3.2.2.2. Provider to Papiea APIs</a></li>
</ul>
</li>
<li><a href="#h-84C4558F-1E90-402F-8156-B73E6B2CEBEC">3.3.2.3. User facing APIs</a></li>
</ul>
</li>
<li><a href="#h-659F7D9D-30A4-4B82-830A-FBA136DB1151">3.3.3. Handling Potential Diffs</a></li>
<li><a href="#h-73267886-ACA6-4CD7-AB24-E0939F5131A5">3.3.4. Change Spec</a>
<ul>
<li><a href="#h-5161D1F8-44C7-46E5-8AF9-35BACC9CC8E7">3.3.4.1. Change Spec Handler Pseudocode</a></li>
</ul>
</li>
<li><a href="#h-C7BC0BF7-81D0-45CD-BE03-399A8071F016">3.3.5. Update Status</a></li>
<li><a href="#h-0AFEADAD-0843-4364-971F-726CFA756F0A">3.3.6. SFS - Status Fields Signature</a>
<ul>
<li><a href="#h-B64344FB-FD29-40E2-B7B8-336E36E010DC">3.3.6.1. Formal syntax of SFS</a></li>
</ul>
</li>
<li><a href="#h-7AB58359-9E2C-4AB3-BE19-05E0EE8EB8C3">3.3.7. Intentful core</a>
<ul>
<li><a href="#h-8D057AB6-1A0C-410C-9C39-66FFB86E234F">3.3.7.1. Differ</a></li>
<li><a href="#h-3FBDA8BC-C7F9-450F-B2A6-52A71B2953E8">3.3.7.2. Intentful Execution</a></li>
</ul>
</li>
<li><a href="#h-6A154AB2-B69C-4C91-9338-198DB12F0672">3.3.8. Execution ID</a></li>
<li><a href="#h-2D1D7EA5-3FF3-4536-BBCC-6CA2F59AFC53">3.3.9. Procedures Signatures</a>
<ul>
<li><a href="#h-33462E2A-9A02-4C95-ADFF-0C6CA0CAE12B">3.3.9.1. Procedure Signature struct</a></li>
</ul>
</li>
<li><a href="#h-7F774C3C-7E2E-44EA-84B9-21E57E4DF769">3.3.10. Understanding Deltas</a>
<ul>
<li><a href="#h-A1BBF1FF-5B15-44B9-AF53-3FC413643E18">3.3.10.1. Matching SFSs to Deltas</a></li>
<li><a href="#h-760CCC2A-F27B-4661-ACC7-02599C7DCDC7">3.3.10.2. Determining Order</a></li>
</ul>
</li>
<li><a href="#h-79A5E9CC-9D3C-41EE-A39C-DCF31ABF20FD">3.3.11. Provider</a></li>
<li><a href="#h-00CF1105-6D19-4BFF-B82A-292EC8F658A9">3.3.12. RBCA - test</a></li>
<li><a href="#h-58305CF9-4FD0-480F-9E33-2704A3A7A5CE">3.3.13. Scalability and Reliability</a>
<ul>
<li><a href="#h-1E7F99CC-B4B5-41D7-9305-5C64BF9BC9AF">3.3.13.1. Leader election</a></li>
<li><a href="#h-E98DAE25-720F-4593-99F5-C3BEC60C6500">3.3.13.2. Fault tolerance</a>
<ul>
<li><a href="#h-9B9442B5-2DA3-4A8A-9748-703AEBA44DC7">3.3.13.2.1. Dead Papiea Instance</a></li>
<li><a href="#h-9B4A9EFB-8CAE-48CA-AF41-0832D8D6ABC5">3.3.13.2.2. Dead Provider</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-3DE0B4AD-2DEB-42C1-9A59-02F509F51C8B">3.3.14. Cleanup process</a></li>
<li><a href="#h-87758AA9-A73F-4A88-AE6A-463CA2936DEA">3.3.15. Auditing</a></li>
</ul>
</li>
<li><a href="#h-8C40554A-6CC9-4526-881B-2BE3D0A70129">3.4. Intentful Tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Continue_Fixing">Continue_Fixing</span></span></a></li>
<li><a href="#h-DCCF80B1-45AB-4C5D-BCF5-A433AC4D37C5">3.5. Provider Library</a>
<ul>
<li><a href="#h-89837841-3C06-4788-ABC5-D3B4BE918654">3.5.1. Define Entity Model</a>
<ul>
<li><a href="#h-9E4F86C1-5088-4875-B037-107AD12A73CB">3.5.1.1. YAML</a></li>
<li><a href="#h-AC6A2914-694E-4B7F-AB99-F915E1B7A0B2">3.5.1.2. CRUD</a></li>
</ul>
</li>
<li><a href="#h-610E1433-DBCF-4169-974D-47A63004F6CA">3.5.2. Initialize</a></li>
<li><a href="#h-576FB59C-5E14-41BB-9D46-253E63A8E082">3.5.3. Callback Mechanism</a></li>
<li><a href="#h-7009B3C1-3D1B-465A-93ED-F35A5AB3CF4D">3.5.4. Running Effect Validator</a></li>
<li><a href="#h-A1199B4C-F994-4548-9A5B-668723B359C2">3.5.5. Status Changes Handlers</a>
<ul>
<li><a href="#h-E991437E-7322-4F46-92DF-6895F8C7EAC1">3.5.5.1. Registring</a></li>
<li><a href="#h-AA340191-E756-4642-B9F5-426FFEFF4ECB">3.5.5.2. Running using context</a></li>
</ul>
</li>
<li><a href="#h-5511BB0C-438F-4EF5-96C3-86642690C568">3.5.6. Procedures</a>
<ul>
<li><a href="#h-CCFBCE3C-C7DB-48C9-B35D-0201EB13D429">3.5.6.1. Registring</a></li>
<li><a href="#h-9B305BB6-112D-4D39-9956-60AE424BBCDA">3.5.6.2. Running using context</a></li>
</ul>
</li>
<li><a href="#h-D6094197-1C78-45BC-9CDD-9E3555897591">3.5.7. Example Provider</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#h-738F973C-D059-4099-BAE9-94F6882FE791">4. Full files</a>
<ul>
<li><a href="#h-69C25B02-B7F5-4567-B14F-B33564795341">4.1. Core definitions</a>
<ul>
<li><a href="#h-7CD37704-4271-4745-A480-217D94B04ED7">4.1.1. /src/core.ts</a></li>
</ul>
</li>
<li><a href="#h-895B51BC-E9D2-4277-88DA-1D57403DAD85">4.2. Databases</a>
<ul>
<li><a href="#h-3E385A6D-FE01-4147-AC9E-8F814FFF663F">4.2.1. /src/databases/spec<sub>db</sub><sub>interface.ts</sub></a></li>
<li><a href="#h-B6BFED5E-E21F-48F2-BDB6-D7DBBB148401">4.2.2. /src/databases/status<sub>db</sub><sub>interface.ts</sub></a></li>
<li><a href="#h-3219E22A-305C-4450-B2DD-D4C0D8C9CE16">4.2.3. /src/databases/providers<sub>db</sub><sub>interface.ts</sub></a></li>
</ul>
</li>
<li><a href="#h-18B3FC53-9C2C-4F04-B851-03488558444E">4.3. Differ</a>
<ul>
<li><a href="#h-535177EF-5CF0-4663-B7E4-FDB12EEA9D64">4.3.1. /src/intentful<sub>core</sub>/differ<sub>interface.ts</sub></a></li>
</ul>
</li>
<li><a href="#h-EB9EEF16-2F6E-4F58-98AF-3846EC9E997D">4.4. Tasks</a>
<ul>
<li><a href="#h-8C021415-DBCE-4114-8612-4E6459B0D1D4">4.4.1. /src/tasks/task<sub>manager</sub><sub>interface.ts</sub></a></li>
</ul>
</li>
<li><a href="#h-9C85FED2-F254-40C5-A4BA-17F40E8C2358">4.5. Provider SDK</a>
<ul>
<li><a href="#h-812BAEAD-238A-458B-AB66-C3E9AA93D621">4.5.1. Typescript: /src/provider<sub>sdk</sub>/typescript<sub>sdk</sub><sub>interface</sub></a></li>
</ul>
</li>
<li><a href="#h-DACB4BA2-5F6F-4327-B21C-1DC041186E62">4.6. /src-go/papiea/engine/core.go</a></li>
<li><a href="#h-00D3A0EA-DB73-4CED-8F7C-4EB3EAA376E9">4.7. /src-go/papiea/engine/server.go</a></li>
<li><a href="#h-E29103D3-EA85-42F9-BF93-145EEE1BF8E7">4.8. /src-go/papiea/engine/provider.go</a></li>
<li><a href="#h-9CA353DE-DC37-4567-B1F7-BEDA37B88D7A">4.9. /src-go/papiea/engine/tasks.go</a></li>
</ul>
</li>
<li><a href="#h-99185D18-042A-41E8-99D9-318CC64F397B">5. Formalities</a></li>
<li><a href="#h-D503B966-E8E7-489B-836E-7B52758EE2E2">6. Last notes</a></li>
</ul>
</div>
</div>
<div class="outline-2" id="meta">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<tbody>
<tr>
<td class="org-left"><b>Author</b></td>
<td class="org-left">Shlomi Vaknin (shlomi.vaknin@nutanix.com)</td>
</tr>

<tr>
<td class="org-left"><b>Date</b></td>
<td class="org-left">2018-12-05 23:35:00</td>
</tr>

<tr>
<td class="org-left"><b>Revision</b></td>
<td class="org-left">DRAFT</td>
</tr>
</tbody>
</table>
</div>

<p>
Papiea is aimed to be a reference implementation of a <a href="#h-99185D18-042A-41E8-99D9-318CC64F397B">formal general purpose intent engine</a>.
</p>

<div id="outline-container-orgae92736" class="outline-2">
<h2 id="h-A6599723-E88D-44A3-A967-AE0C49A54CC6"><a id="orgae92736"></a><span class="section-number-2">1</span> Definitions</h2>
<div class="outline-text-2" id="text-h-A6599723-E88D-44A3-A967-AE0C49A54CC6">
<ul class="org-ul">
<li><span class="underline">Spec</span> - a map containing the desired state of a particular entity</li>
<li><span class="underline">Status</span> - a map containing the current statue of a particular entity. Always a superset of Spec</li>
<li><span class="underline">Metadata</span> - Information of the identity of the entity. Must contain at least <code>uuid</code>, <code>kind</code> and <code>specVersion</code></li>
<li><span class="underline">Spec version</span> - an integer representing the version of the current spec. Updates to spec will
use this field to ensure that the change will be atomic</li>
<li><span class="underline">Entity</span> - The tuple <code>[Metadata, Spec, Status]</code></li>
<li><span class="underline">Kind</span> - The "type" of the entity</li>
<li><span class="underline">Diff</span> - A difference between the current Status and the most recent desired Spec</li>
<li><span class="underline">Providers</span> - Pluggable handlers that can transform an entity from its current state to its desired state</li>
<li><span class="underline">Tasks</span> - a mechanism for following the progress of resolving Diffs</li>
</ul>
</div>
</div>
<div id="outline-container-orge436ea9" class="outline-2">
<h2 id="h-CE2D607E-693A-4AEC-A492-4232FDFB9D78"><a id="orge436ea9"></a><span class="section-number-2">2</span> Basic Interfaces</h2>
<div class="outline-text-2" id="text-h-CE2D607E-693A-4AEC-A492-4232FDFB9D78">
<p>
The main concept behind the intentful approach is the ability to know what is the desired state of
our system and what is the actual current state. Once we have this knowledge, many different kinds
of engines could be built that would attempt to resolve to tension formed when the intended state,
termed the <code>Spec</code>, is different from the current state of the system, termed the <code>Status</code>.
</p>

<p>
In Papiea, we use both <code>Spec</code> and <code>Status</code> to have a complete view of the state of a given entity
identity, marked by the <code>Metadata</code>. The following interfaces capture these most basic concepts.
</p>
</div>

<div id="outline-container-org6dfbcf7" class="outline-3">
<h3 id="h-CE60E8C5-765E-4454-A5F9-2780A2464889"><a id="org6dfbcf7"></a><span class="section-number-3">2.1</span> Metadata</h3>
<div class="outline-text-3" id="text-h-CE60E8C5-765E-4454-A5F9-2780A2464889">
<p>
Metadata has a structured portion which contains fields that defines the identity of a particular
entity. The fields that identify the entity are:
</p>
<ul class="org-ul">
<li><code>uuid</code> - a unique id representing the identity of this entity</li>
<li><code>kind</code> - the "type" of this entity</li>
<li><code>spec_version</code> - the most up-to-date revision of the spec associated with this entity</li>
</ul>

<p>
Other fields are also important:
</p>
<ul class="org-ul">
<li><code>created_at</code> - logs when this entity was created</li>
<li><code>delete_at</code> - annouces if and when will this entity be deleted. If this field is set the entity
will be deleted by a <a href="#h-3DE0B4AD-2DEB-42C1-9A59-02F509F51C8B">Cleanup process</a>.</li>
</ul>

<div class="org-src-container">
<pre class="src src-typescript" id="orgb424140"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Metadata</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Identity fields</span>
    <span style="color: #c0afa7;">uuid</span>: <span style="color: #b3c0a7;">uuid4</span>;
    <span style="color: #a7c0b9;">kind</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
    <span style="color: #c0a7bd;">spec_version</span>: <span style="color: #F0DFAF; font-weight: bold;">number</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Additional fields</span>
    <span style="color: #e0a0bc;">created_at</span>: <span style="color: #a3e0a0;">timestamp</span>;
    <span style="color: #e0d0a0;">delete_at</span>: <span style="color: #a3e0a0;">timestamp</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8ff54ef" class="outline-3">
<h3 id="h-BAE5B042-453A-4E68-9829-DFEED95D9C4F"><a id="org8ff54ef"></a><span class="section-number-3">2.2</span> Spec</h3>
<div class="outline-text-3" id="text-h-BAE5B042-453A-4E68-9829-DFEED95D9C4F">
<p>
The <code>Spec</code>, which is the desired state, is simply a json object, or an unstructured map. It can
and should get a structure when used specifically by any particular entity <a href="#h-1A45850B-821C-439F-BE1C-5CA5FF2B7A79">Kind</a>. However, at the
engine level, a spec is an unstructured map that can be compared to the mirroring <code>Status</code> map to
find any differences. The structure definintion may change by the provider which defines it, say
by upgrading to a newer version (See TODO:).
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="org2daa7d6"><span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Spec</span> = <span style="color: #F0DFAF; font-weight: bold;">any</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf21094b" class="outline-3">
<h3 id="h-48BE09F4-1DFC-4110-9F9F-67399113C57C"><a id="orgf21094b"></a><span class="section-number-3">2.3</span> Status</h3>
<div class="outline-text-3" id="text-h-48BE09F4-1DFC-4110-9F9F-67399113C57C">
<p>
The <code>Status</code>, which is a representation of the true current state of the entity, is also simply a
json. Its content and structure is a superset of <a href="#h-BAE5B042-453A-4E68-9829-DFEED95D9C4F">Spec</a>, meaning that every field in <code>Spec</code> will
also appear in <code>Status</code>, but may contain any extra fields as desired by the provider.
</p>

<p>
I am just learning typescript, so still not sure how to express that <code>Status</code> is an extension of
<code>Spec</code>, but it should be explicit.
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="org0fe12b1"><span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Status</span> = <span style="color: #F0DFAF; font-weight: bold;">any</span>;
</pre>
</div>
</div>
</div>

<div id="outline-container-org910b6a4" class="outline-3">
<h3 id="h-122002C8-E0B4-40F9-A48B-E75FDA28AAC6"><a id="org910b6a4"></a><span class="section-number-3">2.4</span> Entity</h3>
<div class="outline-text-3" id="text-h-122002C8-E0B4-40F9-A48B-E75FDA28AAC6">
<p>
An Entity is simply the tuple <code>(Metadata, Spec, Status)</code>. It usually denotes a snapshot in time of a particular entity.
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="org9d0be7a"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Entity</span> <span style="color: #DCDCCC;">{</span>
  <span style="color: #99bbb4;">metadata</span>: <span style="color: #b6a0e0;">Metadata</span>;
  <span style="color: #e0a0bc;">spec</span>: <span style="color: #c0afa7;">Spec</span>;
  <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7ad6cb2" class="outline-3">
<h3 id="h-1A45850B-821C-439F-BE1C-5CA5FF2B7A79"><a id="org7ad6cb2"></a><span class="section-number-3">2.5</span> Kind</h3>
<div class="outline-text-3" id="text-h-1A45850B-821C-439F-BE1C-5CA5FF2B7A79">
<p>
A Kind is the entity's metadata. It contains an entire description of what the entity is and what
it may do. This information will be used to provideing full CRUD operation on the entity
structure along with custom procedures and intentful handlers.
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="orgd2c7092"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Intentful signature</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">SFS</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Provider_Callback_URL</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Intentful_Signature</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a6bb99;">signature</span>: <span style="color: #a3e0a0;">SFS</span>;
    <span style="color: #b6a0e0;">compiled_signature</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>
    <span style="color: #a3e0a0;">function_callback</span>: <span style="color: #b3c0a7;">Provider_Callback_URL</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Store a struct description parsed from Swagger Model YAML</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Data_Description</span> = <span style="color: #F0DFAF; font-weight: bold;">any</span>;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We may want to support different execution strategies. For now we</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">can only halt intentful execution for the duration of the</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">procedural call</span>
<span style="color: #F0DFAF; font-weight: bold;">enum</span> <span style="color: #7CB8BB;">Procedural_Execution_Strategy</span> <span style="color: #DCDCCC;">{</span><span style="color: #99bbb4;">Halt_Intentful</span><span style="color: #DCDCCC;">}</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Procedural_Signature</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The name of the procedure to be exported by the engine.</span>
    <span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The representation of the data to be passed to this procedure</span>
    <span style="color: #e0a0bc;">argument</span>: <span style="color: #c0afa7;">Data_Description</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The automatically generated validator</span>
    <span style="color: #a7aac0;">arg_validator_fn</span>: <span style="color: #BFEBBF;">(</span><span style="color: #b6a0e0;">arg</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The representation of the data to be returned from this procedure</span>
    <span style="color: #a0d6e0;">result</span>: <span style="color: #c0afa7;">Data_Description</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The automatically generated validator</span>
    <span style="color: #bb99b4;">result_validator_fn</span>: <span style="color: #BFEBBF;">(</span><span style="color: #a0d6e0;">res</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Does the engine pauses all intentful operation invocations for</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">the duration of the procedural call</span>
    <span style="color: #a0d6e0;">execution_strategy</span>: <span style="color: #99bbb4;">Procedural_Execution_Strategy</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Action url into the provider</span>
    <span style="color: #a3e0a0;">procedure_callback</span>: <span style="color: #b3c0a7;">Provider_Callback_URL</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Kind</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The name of the kind, and its plural form for proper REST naming</span>
    <span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
    <span style="color: #e0d0a0;">name_plural</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">//// </span><span style="color: #7F9F7F;">Entity structure</span>
    <span style="color: #b6a0e0;">kind_structure</span>: <span style="color: #c0afa7;">Data_Description</span>;
    <span style="color: #a3e0a0;">validator_fn</span>: <span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>:<span style="color: #bb99b4;">entity</span><span style="color: #BFEBBF;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
    <span style="color: #e0a0bc;">semantic_validator_fn</span>?: <span style="color: #b3c0a7;">Provider_Callback_URL</span>; 

    <span style="color: #5F7F5F;">//// </span><span style="color: #7F9F7F;">Intentful behavior</span>
    <span style="color: #bb99b4;">intentful_signatures</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #a3e0a0;">SFS</span>, <span style="color: #a0d6e0;">Intentful_Signatures</span>&gt;;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Every sfs lists the sfs's it has to execute before</span>
    <span style="color: #e0d0a0;">dependency_tree</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #a3e0a0;">SFS</span>, <span style="color: #a3e0a0;">SFS</span><span style="color: #BFEBBF;">[]</span>&gt;;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The compiled Differ</span>
    <span style="color: #99bbb4;">differ</span>: <span style="color: #b6a0e0;">Differ</span>;

    <span style="color: #5F7F5F;">//// </span><span style="color: #7F9F7F;">Procedural behavior</span>
    <span style="color: #a3e0a0;">procedures</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a3e0a0;">Procedural_Signature</span>&gt;;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
A Kind metadata contains the following pieces:
</p>
<ol class="org-ol">
<li>Identification and structure:
<ol class="org-ol">
<li>a unique name along with its plural form, to generate idiomatic REST API. There may be a
library function that create plural form, if so it should be used instead.</li>

<li>The description of the data structre defined by this kind. The structure is defined using
OpenAPI's model format (Swagger), which is parsed into a walkable tree.</li>

<li>A Validator function is generated from this OpenAPI model specification. The purpose of the
validator function is to ensure that the entity that was sent by the user is syntactically
(structurally) correct.</li>

<li>an optional semantic validator function is defined as a predicate exposed by the <a href="#h-5256D1D9-391F-40C7-B090-EFC90473CDD0">Provider's
SDK</a>. It will be used to ensure that the content of the entity is correct.</li>
</ol></li>

<li>Intentful behavior
<ol class="org-ol">
<li>A map from an intentful signature (see <a href="#h-0AFEADAD-0843-4364-971F-726CFA756F0A">SFS - Status Fields Signature</a>) to a structure
representing the intentful behavior (see TODO:).</li>

<li>Dependency tree between the different intentful behaviors.</li>

<li>Using the two items above, a <code>Differ</code> is compiled. The Differ's task is to determine if
there are any relevant differences between an entity's spec and status (relevant in this
context means "a diff such that there exists at least one intentful behavior which can
resolve it").</li>
</ol></li>

<li>Procedural behavior
<ol class="org-ol">
<li>a map from the procedure name to a structure defining that procedure, its input argument
and output result structures, execution strategy, etc. (see TODO:)</li>
</ol></li>
</ol>
</div>
</div>

<div id="outline-container-orga2ec077" class="outline-3">
<h3 id="h-72D813C8-1AEE-449B-BE2E-0FB4FC53FD5A"><a id="orga2ec077"></a><span class="section-number-3">2.6</span> Entity Reference</h3>
<div class="outline-text-3" id="text-h-72D813C8-1AEE-449B-BE2E-0FB4FC53FD5A">
<p>
Entities can point to other entities using a reference. A reference may onlu refers to the
identity of an entity, and it is the intent engine that returns the entity's most recent spec and
most current status.
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="orge03fb18"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Entity_Reference</span>  <span style="color: #DCDCCC;">{</span>
    <span style="color: #c0afa7;">uuid</span>: <span style="color: #b3c0a7;">uuid4</span>;
    <span style="color: #a7c0b9;">kind</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">This field is optional and is only used help the user identify</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">what this reference is pointing to. </span>
    <span style="color: #bba699;">name</span>?: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3c82668" class="outline-3">
<h3 id="h-97314854-673B-4CD4-874A-B9C1F9AE6B44"><a id="org3c82668"></a><span class="section-number-3">2.7</span> Provider description</h3>
<div class="outline-text-3" id="text-h-97314854-673B-4CD4-874A-B9C1F9AE6B44">
<p>
Papiea is extensible by the use of <code>Providers</code>.  A Provider defines entities by providing their
structure, their procedures and intentful behaviors. Along with declaratively define the entity's
structure, it also enables intentful behaviors by defining how differences between spec and
status may be resolved. The Provider is pluggable at runtime, and should maintain no internal
state, which should allow for simpler methods of scaling.
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="org98db28f"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Provider</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">A unique identifier where all kinds will be under this prefix</span>
    <span style="color: #a0d6e0;">prefix</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
    <span style="color: #e0d0a0;">version</span>: <span style="color: #9999bb;">Version</span>;
    <span style="color: #b6a0e0;">kinds</span>: <span style="color: #99bbb4;">Kind</span><span style="color: #BFEBBF;">[]</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
A <code>Provider Description</code> contains:
</p>
<ol class="org-ol">
<li>A unique identifier for that provider</li>
<li>A version of that provider</li>
<li>The list of Kinds supported by this provider</li>
</ol>
</div>
</div>
</div>

<div id="outline-container-org31bd70a" class="outline-2">
<h2 id="h-855804C6-C489-4C0E-97BC-889C0D9634F2"><a id="org31bd70a"></a><span class="section-number-2">3</span> Modules</h2>
<div class="outline-text-2" id="text-h-855804C6-C489-4C0E-97BC-889C0D9634F2">
</div>
<div id="outline-container-orgf1fe3f2" class="outline-3">
<h3 id="h-66558F55-8F93-44E5-9A37-0BD433627126"><a id="orgf1fe3f2"></a><span class="section-number-3">3.1</span> Databases</h3>
<div class="outline-text-3" id="text-h-66558F55-8F93-44E5-9A37-0BD433627126">
<div class="note">
<p>
<b>Multitenancy</b>: All databases are aware of tenants. It may be implemented as a column or
attribute of a table or document, or as a different database with a different connect uri.
</p>

</div>
</div>

<div id="outline-container-orgb270223" class="outline-4">
<h4 id="h-9E8BF858-2CCE-4A4D-A786-ED53BA3F79E9"><a id="orgb270223"></a><span class="section-number-4">3.1.1</span> Status</h4>
<div class="outline-text-4" id="text-h-9E8BF858-2CCE-4A4D-A786-ED53BA3F79E9">
<p>
Status database will be a mapping from a metadata (namely, <code>uuid</code> and <code>kind</code>) to a status json document. 
</p>

<p>
It may be implemented using a fast in-memory database, since it may require frequent rapid
access depending on an entity's kind requirement. It is not required that this database be
persisted to disk. Its content MUST always be re-acquirable by the providers, simply by asking
all the providers to list up-to-date status of all objects known to them.
</p>

<p>
Each provider for a kind will supply its entity's structure in its YAML.
</p>
</div>

<div id="outline-container-org2ca2a4a" class="outline-5">
<h5 id="h-7E3D79F1-DC44-4C08-8EA0-CC683CEB36BA"><a id="org2ca2a4a"></a><span class="section-number-5">3.1.1.1</span> Interface</h5>
<div class="outline-text-5" id="text-h-7E3D79F1-DC44-4C08-8EA0-CC683CEB36BA">
<div class="org-src-container">
<pre class="src src-typescript" id="orgaf31d0c">
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Status_DB</span><span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Update the status in the status db. As long as the input is</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">correct this always succeeds.</span>
    <span style="color: #c0a7bd;">update_status</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>:<span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #bba699;">status</span>:<span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Gets the status of a particular entity from the db. Returns</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">both current metadata and status of the entity.</span>
    <span style="color: #a6bb99;">get_status</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>:<span style="color: #e0d0a0;">Entity_Reference</span><span style="color: #BFEBBF;">)</span>:<span style="color: #9999bb;">Status</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">List all status that have their fields match the ones given in</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">fields_map. E.g. we could look for all specs for `vm` kind that</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">have a certain ip:</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">list_status({"metadata": {"kind": "vm"},</span>
    <span style="color: #5F7F5F;">//              </span><span style="color: #7F9F7F;">"status":   {"ip":   "10.0.0.10"}})</span>
    <span style="color: #5F7F5F;">//</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We could come up with command such as greater-than etc at some</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">later point, or we could use a similar dsl to mongodb search</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">dsl.</span>
    <span style="color: #9999bb;">list_status</span><span style="color: #BFEBBF;">(</span><span style="color: #c0a7bd;">fields_map</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>: <span style="color: #BFEBBF;">[</span><span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">][]</span>;
<span style="color: #DCDCCC;">}</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org44da37e" class="outline-4">
<h4 id="h-67BEA7CF-81F7-4C99-84AB-FC36B20906C6"><a id="org44da37e"></a><span class="section-number-4">3.1.2</span> Spec</h4>
<div class="outline-text-4" id="text-h-67BEA7CF-81F7-4C99-84AB-FC36B20906C6">
<p>
Unlike status which can always be fetched from the providers, spec is a record of the user's
intent and must be persistent. It must also be scalable and highly available. It must have a
clear notion of atomicity (such as compare-and-set/swap) in order to atomically update spec
values.
</p>
</div>

<div id="outline-container-org131c7bf" class="outline-5">
<h5 id="h-C485E97F-9BAD-4B12-820E-02E408231E6E"><a id="org131c7bf"></a><span class="section-number-5">3.1.2.1</span> Interface</h5>
<div class="outline-text-5" id="text-h-C485E97F-9BAD-4B12-820E-02E408231E6E">
<div class="org-src-container">
<pre class="src src-go" id="orgd9c78be">
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #e0a0bc;">Spec_DB</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Tries to update the spec. Succeeds only if the spec_version</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">field in metadata is currently equals to the one on record. The</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">implementation needs to CAS the spec_version to the increment</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">of itself, and return the new metadata with the new</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">spec_version and the new CASed in spec.</span>
    <span style="color: #93E0E3;">update_spec</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>: <span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #e0a0bc;">spec</span>:<span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">)</span>:<span style="color: #BFEBBF;">[</span><span style="color: #bb99b4;">boolean</span>, <span style="color: #b6a0e0;">Metadata</span>, <span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">]</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the spec of a particular entity from the db. Returns both</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">current metadata and the spec of that entity.</span>
    <span style="color: #93E0E3;">get_spec</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>: <span style="color: #e0d0a0;">Entity_Reference</span><span style="color: #BFEBBF;">)</span>:<span style="color: #BFEBBF;">[</span><span style="color: #b6a0e0;">Metadata</span>, <span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">]</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">List all specs that have their fields match the ones given in</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">fields_map. E.g. we could look for all specs for `vm` kind that</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">have a certain ip:</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">list_specs({"metadata": {"kind": "vm"},</span>
    <span style="color: #5F7F5F;">//             </span><span style="color: #7F9F7F;">"spec":     {"ip":   "10.0.0.10"}})</span>
    <span style="color: #5F7F5F;">//</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We could come up with command such as greater-than etc at some</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">later point, or we could use a similar dsl to mongodb search</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">dsl.</span>
    <span style="color: #93E0E3;">list_specs</span><span style="color: #BFEBBF;">(</span><span style="color: #c0a7bd;">fields_map</span>: <span style="color: #c0afa7;">any</span><span style="color: #BFEBBF;">)</span>: <span style="color: #BFEBBF;">[</span><span style="color: #b6a0e0;">Metadata</span>, <span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">][]</span>;
<span style="color: #DCDCCC;">}</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb9b7d3f" class="outline-4">
<h4 id="h-8693B55A-1808-4981-B1E1-D07BFF286BD3"><a id="orgb9b7d3f"></a><span class="section-number-4">3.1.3</span> Providers</h4>
<div class="outline-text-4" id="text-h-8693B55A-1808-4981-B1E1-D07BFF286BD3">
<p>
Providers database stores all the configurations a provider has registered (encoded in <a href="#h-97314854-673B-4CD4-874A-B9C1F9AE6B44">Provider
description</a> section). It is used by the engine to record which providers are registered. The
engine uses this indirectly to initialize all user-facing APIs. This seperation makes it easy to
scale the engine to many instances.
</p>
</div>

<div id="outline-container-orgdd46028" class="outline-5">
<h5 id="h-48C4E5F4-E98F-4DAA-8DB7-1576C1EC3B09"><a id="orgdd46028"></a><span class="section-number-5">3.1.3.1</span> Interface</h5>
<div class="outline-text-5" id="text-h-48C4E5F4-E98F-4DAA-8DB7-1576C1EC3B09">
<div class="org-src-container">
<pre class="src src-typescript" id="org163f6a3">
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Providers_DB</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Register a new provider with the intent engine</span>
    <span style="color: #e0d0a0;">register_provider</span><span style="color: #BFEBBF;">(</span><span style="color: #e0d0a0;">provider</span>: <span style="color: #e0a0bc;">Provider</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;

    <span style="color: #5F7F5F;">//</span><span style="color: #7F9F7F;">Upgrade a provider - This should be in the admin?</span>
    <span style="color: #5F7F5F;">//</span><span style="color: #7F9F7F;">upgrade_provider(from_provider: uuid4, to: providerDescription): Task;</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">get a provider</span>
    <span style="color: #b3c0a7;">get_provider</span><span style="color: #BFEBBF;">(</span><span style="color: #b3c0a7;">provider_prefix</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #e0d0a0;">version</span>?: <span style="color: #9999bb;">Version</span><span style="color: #BFEBBF;">)</span>: <span style="color: #e0a0bc;">Provider</span><span style="color: #BFEBBF;">[]</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">List all registered providers</span>
    <span style="color: #bba699;">list_providers</span><span style="color: #BFEBBF;">()</span>: <span style="color: #e0a0bc;">Provider</span><span style="color: #BFEBBF;">[]</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Removes and de-registers a provider from the intent engine</span>
    <span style="color: #bba699;">delete_provider</span><span style="color: #BFEBBF;">(</span><span style="color: #e0d0a0;">provider_uuid</span>: <span style="color: #b3c0a7;">uuid4</span><span style="color: #BFEBBF;">)</span>: <span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
<span style="color: #DCDCCC;">}</span>

</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org458307e" class="outline-3">
<h3 id="h-DEA1F8F2-7248-4943-8B88-068C4D3207B5"><a id="org458307e"></a><span class="section-number-3">3.2</span> Dependent services</h3>
<div class="outline-text-3" id="text-h-DEA1F8F2-7248-4943-8B88-068C4D3207B5">
</div>
<div id="outline-container-org7051e47" class="outline-4">
<h4 id="h-A0127E94-8730-4DC2-B3EA-93BEA06DE7F1"><a id="org7051e47"></a><span class="section-number-4">3.2.1</span> Tasks</h4>
<div class="outline-text-4" id="text-h-A0127E94-8730-4DC2-B3EA-93BEA06DE7F1">
<p>
Papiea defines a task to be a mechanism that tracks the progress of change towards a
<b>particular</b> spec version. It does not matter how the change took place: through a provider,
manually or by an error. A task will listen on the relevant status changes and mark off the
different fields as they get resolved. To get a clearer understanding of the logic underlying
this please see <a href="#h-8C40554A-6CC9-4526-881B-2BE3D0A70129">Intentful Tasks</a> section below.
</p>

<div class="note">
<p>
Unlike the traditional definition of a task as a handle to a running process, Papiea does not
start a particular thread or process to that works on a <code>Diff</code>. Instead the task simply listens
the relevant changes in the entity and tracks its progress. 
</p>

</div>
</div>

<div id="outline-container-org0cfe273" class="outline-5">
<h5 id="h-D04F146F-B16A-481B-9CD6-7552308467FF"><a id="org0cfe273"></a><span class="section-number-5">3.2.1.1</span> Interface</h5>
<div class="outline-text-5" id="text-h-D04F146F-B16A-481B-9CD6-7552308467FF">
<div class="org-src-container">
<pre class="src src-typescript" id="org125280a"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Task_Manager</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a7aac0;">wait</span><span style="color: #BFEBBF;">()</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span>;
    <span style="color: #9999bb;">register_delta</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">Diff</span><span style="color: #D0BF8F;">[]</span><span style="color: #BFEBBF;">)</span>;
<span style="color: #DCDCCC;">}</span> 

<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">new_task</span> <span style="color: #DCDCCC;">()</span>: <span style="color: #a7aac0;">Task</span>;
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">new_intentful_task</span> <span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">papiea</span>: <span style="color: #DFAF8F;">Papiea</span>, <span style="color: #DFAF8F;">entity</span>: <span style="color: #DFAF8F;">Entity_Reference</span>, <span style="color: #DFAF8F;">kind</span>: <span style="color: #DFAF8F;">Kind</span>, <span style="color: #DFAF8F;">spec</span>: <span style="color: #DFAF8F;">Spec</span><span style="color: #DCDCCC;">)</span>: <span style="color: #a7aac0;">Task</span>;
</pre>
</div>

<p>
A Task allows you to wait for it to finish.
</p>
</div>
</div>
</div>
</div>

<div id="outline-container-orgb1bfaca" class="outline-3">
<h3 id="h-2DAE1462-7E56-421D-8625-C24A3CF5E16F"><a id="orgb1bfaca"></a><span class="section-number-3">3.3</span> Papiea Engine</h3>
<div class="outline-text-3" id="text-h-2DAE1462-7E56-421D-8625-C24A3CF5E16F">
</div>
<div id="outline-container-orgbbda8be" class="outline-4">
<h4 id="h-8A63D538-E97D-4CC4-B11D-18868DABE10B"><a id="orgbbda8be"></a><span class="section-number-4">3.3.1</span> Initialize</h4>
<div class="outline-text-4" id="text-h-8A63D538-E97D-4CC4-B11D-18868DABE10B">
<p>
When Papiea loads up, it needs to initialize its database connections, load the providers,
generate entity validators and expose CRUD and <a href="#h-5511BB0C-438F-4EF5-96C3-86642690C568">Procedural</a> APIs.
</p>
</div>

<div id="outline-container-orga7bf82b" class="outline-5">
<h5 id="h-3D76A395-5D87-495F-9138-9373F4CC859C"><a id="orga7bf82b"></a><span class="section-number-5">3.3.1.1</span> Interface</h5>
<div class="outline-text-5" id="text-h-3D76A395-5D87-495F-9138-9373F4CC859C">
<div class="org-src-container">
<pre class="src src-typescript" id="orge921f6f"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Papiea</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">api is the mechanism which adds REST endpoints to Papiea.</span>
    <span style="color: #a7aac0;">api</span>: <span style="color: #bba699;">route</span>;
    <span style="color: #a0d6e0;">prefix</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #9999bb;">statusDb</span>: <span style="color: #c0afa7;">Status_DB</span>;
    <span style="color: #bba699;">specsDb</span>: <span style="color: #e0a0bc;">Spec_DB</span>;
    <span style="color: #a7c0b9;">providersDb</span>: <span style="color: #c0afa7;">Providers_DB</span>;
<span style="color: #DCDCCC;">}</span> 
</pre>
</div>
</div>
</div>

<div id="outline-container-orge43968f" class="outline-5">
<h5 id="h-D2D67873-9F25-4339-9391-F10C5114F875"><a id="orge43968f"></a><span class="section-number-5">3.3.1.2</span> Pseudocode</h5>
<div class="outline-text-5" id="text-h-D2D67873-9F25-4339-9391-F10C5114F875">
<div class="org-src-container">
<pre class="src src-typescript" id="org5a1263d"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Initialize papiea engine.</span>
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">initialize_papiea</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">config</span><span style="color: #DCDCCC;">)</span>: <span style="color: #9999bb;">Papiea</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a7c0b9;">papiea</span> = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">Papiea</span><span style="color: #BFEBBF;">()</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Load databases, initialize db connections.</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #9999bb;">statusDb</span> = <span style="color: #c0afa7;">Status_DB</span>.<span style="color: #9999bb;">connect</span><span style="color: #BFEBBF;">(</span><span style="color: #a7aac0;">config</span>.<span style="color: #99bbb4;">status_db</span><span style="color: #BFEBBF;">)</span>;
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a0d6e0;">specDb</span> = <span style="color: #e0a0bc;">Spec_DB</span>.<span style="color: #9999bb;">connect</span><span style="color: #BFEBBF;">(</span><span style="color: #a7aac0;">config</span>.<span style="color: #e0a0bc;">spec_db</span><span style="color: #BFEBBF;">)</span>;
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7c0b9;">providersDb</span> = <span style="color: #a0d6e0;">Provider_DB</span>.<span style="color: #9999bb;">connect</span><span style="color: #BFEBBF;">(</span><span style="color: #a7aac0;">config</span>.<span style="color: #b3c0a7;">provider_db</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Sets up the rest api engine.</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7aac0;">api</span> = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">rest.api</span><span style="color: #BFEBBF;">()</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Start admin facing apis.</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #bba699;">create_admin_facing_API</span><span style="color: #BFEBBF;">()</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Start providers facing apis.</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #c0afa7;">create_providers_facing_API</span><span style="color: #BFEBBF;">()</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Start user facing apis.</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #b3c0a7;">create_user_facing_API</span><span style="color: #BFEBBF;">()</span>;

    <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #a7c0b9;">papiea</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org293be78" class="outline-4">
<h4 id="h-7899FFEB-F907-4103-B591-11240E8BF9DE"><a id="org293be78"></a><span class="section-number-4">3.3.2</span> Exporting APIs</h4>
<div class="outline-text-4" id="text-h-7899FFEB-F907-4103-B591-11240E8BF9DE">
<p>
Papiea provides three tiers of APIs: Admin, Provider and User facing.
</p>

<div class="org-src-container">
<pre class="src src-go" id="org6907778"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #a7aac0;">papiea_APIs</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #93E0E3;">create_admin_facing_API</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">papiea</span>:<span style="color: #9999bb;">Papiea</span><span style="color: #BFEBBF;">)</span>:<span style="color: #a7c0b9;">void</span>
    <span style="color: #93E0E3;">create_provider_facing_API</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">papiea</span>:<span style="color: #9999bb;">Papiea</span><span style="color: #BFEBBF;">)</span>:<span style="color: #a7c0b9;">void</span>
    <span style="color: #93E0E3;">create_user_facing_API</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">papiea</span>:<span style="color: #9999bb;">Papiea</span><span style="color: #BFEBBF;">)</span>:<span style="color: #a7c0b9;">void</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
Next sections go into greater details into each of the apis.
</p>
</div>
<div id="outline-container-orgdf890fb" class="outline-5">
<h5 id="h-D6CB7ACB-5E8E-4AC1-92BE-D35612E45558"><a id="orgdf890fb"></a><span class="section-number-5">3.3.2.1</span> Admin facing APIs</h5>
<div class="outline-text-5" id="text-h-D6CB7ACB-5E8E-4AC1-92BE-D35612E45558">
<p>
The admin apis exposed by Papiea are used to manage providers: registrating, upgrading, deleting etc.
</p>
</div>
<div id="outline-container-org17a2b34" class="outline-6">
<h6 id="h-CF1BC3A4-03DC-4305-ADFD-D8AADFEA0C2E"><a id="org17a2b34"></a><span class="section-number-6">3.3.2.1.1</span> Pseudocode</h6>
<div class="outline-text-6" id="text-h-CF1BC3A4-03DC-4305-ADFD-D8AADFEA0C2E">
<div class="org-src-container">
<pre class="src src-typescript" id="org70a772c"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">create_admin_facing_API</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">papiea</span>:<span style="color: #DFAF8F;">Papiea</span><span style="color: #DCDCCC;">)</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">An example for registring a new provider from a provider description</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7aac0;">api</span>.<span style="color: #e0d0a0;">POST</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7aac0;">api</span>.<span style="color: #a0d6e0;">prefix</span>+ <span style="color: #CC9393;">"/providers"</span>, <span style="color: #F0DFAF; font-weight: bold;">function</span><span style="color: #D0BF8F;">(</span><span style="color: #DFAF8F;">req</span>, <span style="color: #DFAF8F;">res</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
        <span style="color: #bba699;">registerOrUpgradeProvider</span><span style="color: #93E0E3;">(</span><span style="color: #a0d6e0;">req</span>.<span style="color: #e0d0a0;">providerDescription</span><span style="color: #93E0E3;">)</span>;
    <span style="color: #D0BF8F;">}</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">...</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org36ecc26" class="outline-5">
<h5 id="h-58B8746D-246B-437B-9457-04F667D64751"><a id="org36ecc26"></a><span class="section-number-5">3.3.2.2</span> Provider facing APIs</h5>
<div class="outline-text-5" id="text-h-58B8746D-246B-437B-9457-04F667D64751">
<p>
Provider has two sets of APIs:
</p>
</div>
<div id="outline-container-orgc64992c" class="outline-6">
<h6 id="h-5256D1D9-391F-40C7-B090-EFC90473CDD0"><a id="orgc64992c"></a><span class="section-number-6">3.3.2.2.1</span> Provider's SDK</h6>
<div class="outline-text-6" id="text-h-5256D1D9-391F-40C7-B090-EFC90473CDD0">
<p>
This is actually an SDK rather than an API. The distinction is that this is used by the
providers developers to define and expose behaviors and APIs to the end user.
</p>

<p>
This SDK will be availagble in a few languages: Javascript and golang are planned first, but
more should come.
</p>

<p>
The core is the <code>Provider</code> abstraction:
</p>
<div class="org-src-container">
<pre class="src src-typescript" id="org0bbe255"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Api for the provider-sdk</span>
<span style="color: #F0DFAF; font-weight: bold;">enum</span> <span style="color: #7CB8BB;">Provider_Power</span> <span style="color: #DCDCCC;">{</span><span style="color: #b6a0e0;">On</span>, <span style="color: #b6a0e0;">Off</span>, <span style="color: #9999bb;">Suspended</span><span style="color: #DCDCCC;">}</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Provider</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #b3c0a7;">new_kind</span><span style="color: #BFEBBF;">(</span><span style="color: #a0d6e0;">entity_yaml</span>:<span style="color: #c0afa7;">Data_Description</span><span style="color: #BFEBBF;">)</span>:<span style="color: #99bbb4;">Kind</span>;
    <span style="color: #e0d0a0;">version</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">major</span>:<span style="color: #F0DFAF; font-weight: bold;">number</span>, <span style="color: #a6bb99;">minor</span>:<span style="color: #F0DFAF; font-weight: bold;">number</span>, <span style="color: #e0a0bc;">build</span>: <span style="color: #F0DFAF; font-weight: bold;">number</span>, <span style="color: #e0d0a0;">extra</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;
    <span style="color: #c0a7bd;">power</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">state</span>: <span style="color: #a7aac0;">Provider_Power</span><span style="color: #BFEBBF;">)</span>: <span style="color: #a7aac0;">Provider_Power</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
This allows us to register a new kind (see below), establish a version and change the "Power
state" of this provider instance. 
</p>

<p>
A Kind is added when the user supplies a valid description for the entity handled by this
kind. Once the kind's entity description is validated, an object of type <code>Kind</code> is returned on
which we can do the following things:
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="orgc5d8f3a"><span style="color: #F0DFAF; font-weight: bold;">enum</span> <span style="color: #7CB8BB;">Procedural_Execution_Strategy</span> <span style="color: #DCDCCC;">{</span><span style="color: #99bbb4;">Halt_Intentful</span><span style="color: #DCDCCC;">}</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Kind</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Adds an intentful handler. Dispatched based on the signautre passed</span>
    <span style="color: #e0a0bc;">on</span><span style="color: #BFEBBF;">(</span><span style="color: #a6bb99;">signature</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>, <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #bba699;">IntentfulCtx</span>, <span style="color: #bb99b4;">entity</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">void</span><span style="color: #BFEBBF;">)</span>:<span style="color: #e0a0bc;">Intentful_Handler</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Convenient functions for constructing/destructing an entity. Could be implemented in terms of "on above"</span>
    <span style="color: #9999bb;">on_new</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>, <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #bba699;">IntentfulCtx</span>, <span style="color: #bb99b4;">entity</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">void</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;
    <span style="color: #b3c0a7;">on_del</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>, <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #bba699;">IntentfulCtx</span>, <span style="color: #bb99b4;">entity</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">void</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Adds a procedural behaviour to the entity</span>
    <span style="color: #9999bb;">procedure</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>,
              <span style="color: #9999bb;">strategy</span>: <span style="color: #99bbb4;">Procedural_Execution_Strategy</span>,
              <span style="color: #a0d6e0;">input_desc</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>,
              <span style="color: #bb99b4;">output_desc</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>,
              <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #9999bb;">ProceduralCtx</span>, <span style="color: #e0d0a0;">input</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;


    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Visualize all the intentful handlers and their priority</span>
    <span style="color: #a7aac0;">visualize_intentful_handlers</span><span style="color: #BFEBBF;">(</span><span style="color: #99bbb4;">filename</span>:<span style="color: #F0DFAF; font-weight: bold;">string</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
We can add an intentful behavior to any set of changes to the entity's fields, either status
(through a real change to the underlying resource, or spec (through a newly submitted user's
intent), by declaring a handler using the <code>on</code> function.
</p>

<p>
We could also register a procedure on that entity. The procedure should not change status in
ways that may cause a new differences. If that happens, the intent engine will try to
"resolve" the diff incured by the procedure. A procedure may state what should happen during
its execution. One such strategy is that no intentful behavior should be handled. If that is
the case, when the procedure finishes execution, the <code>Differ</code> will run again on the entity to
see if any new diffs are needed to be resolved.
</p>

<p>
When we have multiple intentful handlers, it may be desirable to be able to define a
dependency tree between the different intentful handlers. Which should execute before which:
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="org1e18350"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Intentful_Handler</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Establishes a dependency tree between the various handlers</span>
    <span style="color: #c0afa7;">before</span><span style="color: #BFEBBF;">(</span>...<span style="color: #bb99b4;">handlers</span>: <span style="color: #e0a0bc;">Intentful_Handler</span><span style="color: #D0BF8F;">[]</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
In this snippet, <code>h1.before(h2, h3)</code> would mean that if the <code>Differ</code> discovered that both
<code>h1</code>, <code>h2</code> and <code>h3</code> are possibilities of execution, the handler <code>h1</code> should execute first,
then <code>h2</code> and <code>h3</code> have no specific ordering. In cases of no order, the handler with the most
specific signature (i.e. longest) should run first, if both are equal one would be selected at
random.
</p>

<p>
During the execution of an intentful handler, the following functionality could be used:
</p>
<div class="org-src-container">
<pre class="src src-typescript" id="org9e7b8be"><span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">IntentfulCtx</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #c0a7bd;">update_status</span><span style="color: #BFEBBF;">(</span><span style="color: #99bbb4;">metadata</span>: <span style="color: #b6a0e0;">Metadata</span>, <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
    <span style="color: #bba699;">update_progress</span><span style="color: #BFEBBF;">(</span><span style="color: #99bbb4;">message</span>:<span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a3e0a0;">done_percent</span>:<span style="color: #F0DFAF; font-weight: bold;">number</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">For the time being these are equal. Later they may differ</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">ProceduralCtx</span>=<span style="color: #bba699;">IntentfulCtx</span>;
</pre>
</div>

<p>
During the execution of a handler we may want to set up the status of the entity we are
working on, or perhaps update the task with our progress (if we have one). 
</p>

<p>
I would say that best practice is to have a single <code>get_status(entity_metadata)</code> function that
constructs a full status map out of the real resource, and only call <code>update_status(metadata,
      get_status(metadata))</code>, as this will ensure that even in case of a crash the status we saved
is the exact one that would any way be generated by looking at the real resource.
</p>
</div>
</div>

<div id="outline-container-orgba54bdf" class="outline-6">
<h6 id="h-3862D814-9E80-414B-B086-16A05A2710FE"><a id="orgba54bdf"></a><span class="section-number-6">3.3.2.2.2</span> Provider to Papiea APIs</h6>
<div class="outline-text-6" id="text-h-3862D814-9E80-414B-B086-16A05A2710FE">
<p>
Provider facing APIs define the interactions between a provider and the
intent-engine.  They let the provider register <a href="#h-0AFEADAD-0843-4364-971F-726CFA756F0A">Status Fields Signature</a>
handlers for intentful apis, and handlers for procedural apis which will be exposed to
the user.
</p>

<p>
Three apis are exposed:
</p>
<ul class="org-ul">
<li><code>POST "/status"</code> - sends a voluntary status update regarding an entity. Recieves a context
which identifies the context in which this was called, the metadata of entity and its new
status. This functionality is only exposed to the providers, since they are the only view
Papiea has of the real world.</li>
<li><code>POST "/progress</code> - sends a voluntary progress update for the task, should one exist.</li>
</ul>

<div class="org-src-container">
<pre class="src src-typescript" id="org620c8b8"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">create_provider_facing_API</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">papiea</span>: <span style="color: #DFAF8F;">Papiea</span><span style="color: #DCDCCC;">)</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Registering Provider Facing APIs.</span>
    <span style="color: #a7aac0;">api</span> = <span style="color: #bba699;">papieaApis</span>.<span style="color: #a7aac0;">api</span>
    <span style="color: #bb99b4;">papieaPrefix</span> = <span style="color: #bba699;">papieaApis</span>.<span style="color: #a0d6e0;">prefix</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Status update is only exposed to providers. Users can't update status.</span>
    <span style="color: #a7aac0;">api</span>.<span style="color: #e0d0a0;">POST</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">papiea</span>+<span style="color: #CC9393;">"/status"</span>, <span style="color: #F0DFAF; font-weight: bold;">function</span><span style="color: #D0BF8F;">(</span><span style="color: #DFAF8F;">req</span>, <span style="color: #DFAF8F;">res</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
        <span style="color: #a0d6e0;">res</span>.<span style="color: #bba699;">status</span><span style="color: #93E0E3;">(</span><span style="color: #9999bb;">statusDb</span>.<span style="color: #a6bb99;">updateStatus</span><span style="color: #9FC59F;">(</span><span style="color: #a0d6e0;">req</span>.<span style="color: #c0afa7;">uuid</span>, <span style="color: #a0d6e0;">req</span>.<span style="color: #bba699;">status</span><span style="color: #9FC59F;">)</span> ? <span style="color: #c0a7bd;">200</span> : <span style="color: #a6bb99;">400</span><span style="color: #93E0E3;">)</span>
        <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #a0d6e0;">res</span>;
    <span style="color: #D0BF8F;">}</span><span style="color: #BFEBBF;">)</span>

    <span style="color: #5F7F5F;">// </span>
    <span style="color: #a7aac0;">api</span>.<span style="color: #e0d0a0;">POST</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">papiea</span>+<span style="color: #CC9393;">"/progress"</span>, <span style="color: #F0DFAF; font-weight: bold;">function</span><span style="color: #D0BF8F;">(</span><span style="color: #DFAF8F;">req</span>, <span style="color: #DFAF8F;">res</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
        <span style="color: #5F7F5F;">//</span><span style="color: #7F9F7F;">...</span>
        <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #a0d6e0;">res</span>;
    <span style="color: #D0BF8F;">}</span><span style="color: #BFEBBF;">)</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org36c85c2" class="outline-5">
<h5 id="h-84C4558F-1E90-402F-8156-B73E6B2CEBEC"><a id="org36c85c2"></a><span class="section-number-5">3.3.2.3</span> User facing APIs</h5>
<div class="outline-text-5" id="text-h-84C4558F-1E90-402F-8156-B73E6B2CEBEC">
<p>
The user facing APIs will be generated from all the registered kinds of all registered
providers. The following pseudo-code will be demosstrating how the CRUD may be implemented.
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="org773db43"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">create_user_facing_API</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">papiea</span>: <span style="color: #DFAF8F;">Papiea</span><span style="color: #DCDCCC;">)</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a7c0b9;">papiea</span>.<span style="color: #bba699;">providers</span>.<span style="color: #a0d6e0;">listProviders</span>.<span style="color: #bba699;">forEach</span><span style="color: #BFEBBF;">(</span><span style="color: #D0BF8F;">(</span><span style="color: #a7c0b9;">provider_desc</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #D0BF8F;">{</span>
        <span style="color: #a7c0b9;">provider_desc</span>.<span style="color: #b6a0e0;">kinds</span>.<span style="color: #bba699;">forEach</span><span style="color: #93E0E3;">(</span><span style="color: #9FC59F;">(</span><span style="color: #a7c0b9;">kind</span><span style="color: #9FC59F;">)</span>=&gt;<span style="color: #9FC59F;">{</span>

            <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">define CRUD for entity:</span>
            <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Create: </span>
            <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7aac0;">api</span>.<span style="color: #e0d0a0;">POST</span><span style="color: #94BFF3;">(</span><span style="color: #a7c0b9;">papiea</span>.<span style="color: #a0d6e0;">prefix</span> + <span style="color: #CC9393;">"/"</span> + <span style="color: #a7c0b9;">kind</span>.<span style="color: #e0d0a0;">name_plural</span>, <span style="color: #c0afa7;">handler_spec_change</span><span style="color: #E0CF9F;">(</span><span style="color: #a7c0b9;">kind</span>, <span style="color: #a7c0b9;">papiea</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>;

            <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Update: The core of our intentfullness</span>
            <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7aac0;">api</span>.<span style="color: #c0a7bd;">PUT</span><span style="color: #94BFF3;">(</span><span style="color: #a7c0b9;">papiea</span>.<span style="color: #a0d6e0;">prefix</span> + <span style="color: #CC9393;">"/"</span> + <span style="color: #a7c0b9;">kind</span>.<span style="color: #e0d0a0;">name_plural</span> + <span style="color: #CC9393;">"/{uuid}"</span>, <span style="color: #c0afa7;">handler_spec_change</span><span style="color: #E0CF9F;">(</span><span style="color: #a7c0b9;">kind</span>, <span style="color: #a7c0b9;">papiea</span><span style="color: #E0CF9F;">)</span><span style="color: #94BFF3;">)</span>;

            <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Read</span>
            <span style="color: #a7c0b9;">papiea</span>.<span style="color: #a7aac0;">api</span>.<span style="color: #a7c0b9;">GET</span><span style="color: #94BFF3;">(</span><span style="color: #a7c0b9;">papiea</span>.<span style="color: #a0d6e0;">prefix</span> + <span style="color: #CC9393;">"/"</span> + <span style="color: #a7c0b9;">kind</span>.<span style="color: #e0d0a0;">name_plural</span> + <span style="color: #CC9393;">"/{uuid}"</span>, <span style="color: #E0CF9F;">(</span><span style="color: #a0d6e0;">req</span>, <span style="color: #a0d6e0;">res</span><span style="color: #E0CF9F;">)</span>=&gt;<span style="color: #E0CF9F;">{</span>

                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">metadata is stored in spec as well</span>
                <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">spec</span>   = <span style="color: #a7c0b9;">papiea</span>.<span style="color: #e0a0bc;">spec_db</span>.<span style="color: #c0afa7;">get_spec</span><span style="color: #8FB28F;">(</span><span style="color: #6CA0A3;">{</span><span style="color: #a7c0b9;">kind</span>: <span style="color: #a7c0b9;">kind</span>.<span style="color: #bba699;">name</span>, <span style="color: #c0afa7;">uuid</span>: <span style="color: #a7c0b9;">kind</span>.<span style="color: #c0afa7;">uuid</span><span style="color: #6CA0A3;">}</span><span style="color: #8FB28F;">)</span>;
                <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">status</span> = <span style="color: #a7c0b9;">papiea</span>.<span style="color: #99bbb4;">status_db</span>.<span style="color: #a6bb99;">get_status</span><span style="color: #8FB28F;">(</span><span style="color: #6CA0A3;">{</span><span style="color: #a7c0b9;">kind</span>: <span style="color: #a7c0b9;">kind</span>.<span style="color: #bba699;">name</span>, <span style="color: #c0afa7;">uuid</span>: <span style="color: #a7c0b9;">kind</span>.<span style="color: #c0afa7;">uuid</span><span style="color: #6CA0A3;">}</span><span style="color: #8FB28F;">)</span>;

                <span style="color: #a0d6e0;">res</span>.<span style="color: #bba699;">status</span><span style="color: #8FB28F;">(</span><span style="color: #c0a7bd;">200</span><span style="color: #8FB28F;">)</span>.<span style="color: #c0afa7;">send</span><span style="color: #8FB28F;">(</span><span style="color: #bb99b4;">entity</span><span style="color: #6CA0A3;">(</span><span style="color: #e0a0bc;">spec</span>, <span style="color: #bba699;">status</span><span style="color: #6CA0A3;">)</span><span style="color: #8FB28F;">)</span>;
                <span style="color: #F0DFAF; font-weight: bold;">return</span>;
            <span style="color: #E0CF9F;">}</span><span style="color: #94BFF3;">)</span>;
        <span style="color: #9FC59F;">}</span><span style="color: #93E0E3;">)</span>;
    <span style="color: #D0BF8F;">}</span><span style="color: #BFEBBF;">)</span>;
<span style="color: #DCDCCC;">}</span>;
</pre>
</div>

<p>
<code>Create</code> and <code>Update</code> are essentially the same, and the functionality that handles them is
captured in <a href="#h-5161D1F8-44C7-46E5-8AF9-35BACC9CC8E7"><code>handle_spec_change</code></a>.
</p>
</div>
</div>
</div>

<div id="outline-container-org67c24e1" class="outline-4">
<h4 id="h-659F7D9D-30A4-4B82-830A-FBA136DB1151"><a id="org67c24e1"></a><span class="section-number-4">3.3.3</span> Handling Potential Diffs</h4>
<div class="outline-text-4" id="text-h-659F7D9D-30A4-4B82-830A-FBA136DB1151">
<p>
The engine will check for potential diffs on entities as a response to a few events:
</p>
<ol class="org-ol">
<li>A spec change took place</li>
<li>A status change took place</li>
<li>A predefined timeout happened</li>
</ol>
</div>
</div>

<div id="outline-container-orgf598994" class="outline-4">
<h4 id="h-73267886-ACA6-4CD7-AB24-E0939F5131A5"><a id="orgf598994"></a><span class="section-number-4">3.3.4</span> Change Spec</h4>
<div class="outline-text-4" id="text-h-73267886-ACA6-4CD7-AB24-E0939F5131A5">
<p>
A spec can only change through the <a href="#h-84C4558F-1E90-402F-8156-B73E6B2CEBEC">User facing APIs</a>. It returns an <a href="#h-8C40554A-6CC9-4526-881B-2BE3D0A70129">Intentful Tasks</a> which is then
used to track this change. After the task is returned the system verifies that the change is
correct, both syntactically and optionally semantically (See <a href="#h-1A45850B-821C-439F-BE1C-5CA5FF2B7A79">Kind</a>). If this passes, it then
attempts to atomically apply this spec change. If it succeeds, the <a href="#h-8D057AB6-1A0C-410C-9C39-66FFB86E234F">Differ</a> is invoked on the
entity and the resulting <code>Diffs</code> are <a href="#h-3FBDA8BC-C7F9-450F-B2A6-52A71B2953E8">Intentfuly Executed</a>. However, if the engine fails to
atomically swap in the new spec change, the returned <code>Task</code> will contain a failure. It is up to
the user to get the new entity state, reaply the relevant changes and re-submit a new spec
change.
</p>
</div>

<div id="outline-container-org1bd13aa" class="outline-5">
<h5 id="h-5161D1F8-44C7-46E5-8AF9-35BACC9CC8E7"><a id="org1bd13aa"></a><span class="section-number-5">3.3.4.1</span> Change Spec Handler Pseudocode</h5>
<div class="outline-text-5" id="text-h-5161D1F8-44C7-46E5-8AF9-35BACC9CC8E7">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">handle_spec_change</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">kind</span>: <span style="color: #DFAF8F;">Kind</span>, <span style="color: #DFAF8F;">papiea</span>: <span style="color: #DFAF8F;">Papiea</span><span style="color: #DCDCCC;">)</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #BFEBBF;">(</span><span style="color: #a0d6e0;">req</span>, <span style="color: #a0d6e0;">res</span><span style="color: #BFEBBF;">)</span> =&gt; <span style="color: #BFEBBF;">{</span>
        <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>!<span style="color: #a7c0b9;">kind</span>.<span style="color: #a3e0a0;">validator_fn</span><span style="color: #93E0E3;">(</span><span style="color: #a0d6e0;">req</span>.<span style="color: #e0a0bc;">spec</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
            <span style="color: #a0d6e0;">res</span>.<span style="color: #bba699;">status</span><span style="color: #93E0E3;">(</span><span style="color: #a6bb99;">400</span><span style="color: #93E0E3;">)</span>.<span style="color: #c0afa7;">send</span><span style="color: #93E0E3;">(</span><span style="color: #CC9393;">"Does not conform syntactically"</span><span style="color: #93E0E3;">)</span>;
            <span style="color: #F0DFAF; font-weight: bold;">return</span>;
        <span style="color: #D0BF8F;">}</span>

        <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span><span style="color: #a7c0b9;">kind</span>.<span style="color: #e0a0bc;">semantic_validator_fn</span> &amp;&amp; <span style="color: #99bbb4;">rest</span>.<span style="color: #99bbb4;">post</span><span style="color: #93E0E3;">(</span><span style="color: #a7c0b9;">kind</span>.<span style="color: #e0a0bc;">semantic_validator_fn</span>, <span style="color: #a0d6e0;">req</span>.<span style="color: #e0a0bc;">spec</span><span style="color: #93E0E3;">)</span>!=<span style="color: #c0a7bd;">200</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
            <span style="color: #a0d6e0;">res</span>.<span style="color: #bba699;">status</span><span style="color: #93E0E3;">(</span><span style="color: #a6bb99;">400</span><span style="color: #93E0E3;">)</span>.<span style="color: #c0afa7;">send</span><span style="color: #93E0E3;">(</span><span style="color: #CC9393;">"Does not conform semantically"</span><span style="color: #93E0E3;">)</span>;
            <span style="color: #F0DFAF; font-weight: bold;">return</span>;
        <span style="color: #D0BF8F;">}</span>

        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">create and return the task</span>
        <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">task</span> = <span style="color: #99bbb4;">create_task</span><span style="color: #D0BF8F;">(</span>...<span style="color: #D0BF8F;">)</span>;
        <span style="color: #F0DFAF; font-weight: bold;">return</span> <span style="color: #e0a0bc;">task</span>; <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">magically return here.</span>

        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The followin code should run after the return, so</span>
        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">maybe async, maybe some event loop etc.</span>
        <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span>!<span style="color: #a7c0b9;">papiea</span>.<span style="color: #e0a0bc;">spec_db</span>.<span style="color: #a7c0b9;">update_spec</span><span style="color: #93E0E3;">(</span><span style="color: #a0d6e0;">req</span>.<span style="color: #99bbb4;">metadata</span>, <span style="color: #a0d6e0;">req</span>.<span style="color: #e0a0bc;">spec</span><span style="color: #93E0E3;">)</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
            <span style="color: #e0a0bc;">task</span>.<span style="color: #c0afa7;">fail</span><span style="color: #93E0E3;">(</span><span style="color: #CC9393;">"could not cas task"</span><span style="color: #93E0E3;">)</span>
        <span style="color: #D0BF8F;">}</span>

        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the newest status</span>
        <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">status</span> = <span style="color: #a7c0b9;">papiea</span>.<span style="color: #99bbb4;">status_db</span>.<span style="color: #a6bb99;">get_status</span><span style="color: #D0BF8F;">(</span><span style="color: #93E0E3;">{</span><span style="color: #a7c0b9;">kind</span>: <span style="color: #a7c0b9;">kind</span>.<span style="color: #bba699;">name</span>, <span style="color: #c0afa7;">uuid</span>: <span style="color: #a0d6e0;">req</span>.<span style="color: #bb99b4;">entity</span>.<span style="color: #99bbb4;">metadata</span>.<span style="color: #c0afa7;">uuid</span><span style="color: #93E0E3;">}</span><span style="color: #D0BF8F;">)</span>;

        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the next diff. If the diff is a brand new item, the</span>
        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">next_func is an "on_new" func, similarly, if the spec is one</span>
        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">that removes the item the next func is an "on_del" func.</span>
        <span style="color: #F0DFAF; font-weight: bold;">let</span> <span style="color: #DFAF8F;">next_func</span> : <span style="color: #bba699;">Diff</span> = <span style="color: #a7c0b9;">provider_desc</span>.<span style="color: #99bbb4;">differ</span>.<span style="color: #a7c0b9;">next_diff</span><span style="color: #D0BF8F;">(</span><span style="color: #a0d6e0;">req</span>.<span style="color: #99bbb4;">metadata</span>, <span style="color: #a0d6e0;">req</span>.<span style="color: #e0a0bc;">spec</span>, <span style="color: #bba699;">status</span><span style="color: #D0BF8F;">)</span>;

        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">invoke it</span>
        <span style="color: #b6a0e0;">next_func</span>.<span style="color: #a7aac0;">invoke</span><span style="color: #D0BF8F;">()</span>;
    <span style="color: #BFEBBF;">}</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org38bcdf8" class="outline-4">
<h4 id="h-C7BC0BF7-81D0-45CD-BE03-399A8071F016"><a id="org38bcdf8"></a><span class="section-number-4">3.3.5</span> Update Status</h4>
<div class="outline-text-4" id="text-h-C7BC0BF7-81D0-45CD-BE03-399A8071F016">
<p>
A change of status may only arrive from a provider through the <a href="#h-5256D1D9-391F-40C7-B090-EFC90473CDD0">Provider's SDK</a>'s <code>update_status</code>
function. A change of status may cause differences with regards to a the current spec, and so it
may also be a cause for executing intentful actions. Although it does not return an explicit
<code>Task</code> an implicit one may be created (see <a href="#h-8C40554A-6CC9-4526-881B-2BE3D0A70129">Intentful Tasks</a>). 
</p>
</div>
</div>

<div id="outline-container-orgf6295df" class="outline-4">
<h4 id="h-0AFEADAD-0843-4364-971F-726CFA756F0A"><a id="orgf6295df"></a><span class="section-number-4">3.3.6</span> SFS - Status Fields Signature</h4>
<div class="outline-text-4" id="text-h-0AFEADAD-0843-4364-971F-726CFA756F0A">
<p>
The Status Fields Signature is a formal dsl that describes which fields in status have to change
in order to resolve some difference. It is at the core of our Intentful Dispatch mechanism.
</p>

<p>
Ths signature is essentially a string consisting of field names concatenated with a ".". All of
the fields but the last one constitutes the <code>Path</code> that must be taken, and the last fields of
the string describes the field which should differ. 
</p>

<p>
A special case in this definition is when a value for a field is a vector. In this case, instead
of a field we have an "Item identifier", which is also a list of fields concatenated with a ".",
that describes the identity or the item we are looking for.
</p>

<p>
Lets see some examples for a kind <code>hosts</code>:
</p>

<ol class="org-ol">
<li><p>
<code>name</code> - Matches when an existing host is asking to rename itself. See the following example:
</p>
<pre class="example">
current host entity : {metadata {uuid "1234"
                                 kind "host"
                                 specVersion 3}
                       status   {name "a"
                                 network  [{mac "1.1.1.1.1"
                                            cidr "10.0.0.0"
                                            prefix_length 24}]}
                       spec     {name "a"
                                 network  [{mac "1.1.1.1.1"
                                            cidr "10.0.0.0"
                                            prefix_length 24}]}}

new spec change: {metadata {uuid "1234"
                            kind "host"
                            specVersion 4}
                  spec     {name "new name"                    &lt;&lt; DIFF
                            network  [{mac "1.1.1.1.1"
                                       cidr "10.0.0.0"
                                       prefix_length 24}]}}
</pre>

<p>
In this example, after successfully setting the new spec, the entity would look like this:
</p>
<pre class="example">
current host entity : {metadata {uuid "1234"
                                 kind "host"
                                 specVersion 4}               &lt;&lt; Updated
                       status   {name "a"
                                 network  [{mac "1.1.1.1.1"
                                            cidr "10.0.0.0"
                                            prefix_length 24}]}
                       spec     {name "new name"               &lt;&lt; DIFF
                                 network  [{mac "1.1.1.1.1"
                                            cidr "10.0.0.0"
                                            prefix_length 24}]}}

</pre>

<p>
We can see that the difference for the a particular host entity is only in the <code>name</code>
field. Thus, we want to find a function that knows how to transform the <code>name</code> status
field. The engine will invoke the function that can resolve this diff.
</p></li>

<li><p>
<code>networks.+{mac}</code> a signature that matches when a new network is added into a vector found
for key "networks" on an existing entity, where the new network is identified by a field
called "mac". Lets see this in the example, considering the <code>current host entity</code> as before:
</p>
<pre class="example">
new spec change: {metadata {uuid "1234"
                            kind "host"
                            specVersion 4}
                  spec     {name "a"
                            network  [{mac "1.1.1.1.1"
                                       cidr "10.0.0.0"
                                       prefix_length 24}
                                      {mac "2.2.2.2.2"     &lt;&lt; DIFF
                                       cidr "10.1.0.0"
                                       prefix_length 24}]}}
</pre>

<p>
And we can see that once this new spec change will be atomically swapped in, there will be a
diff only in the <code>network</code> key, and a new item (identifiable by <code>mac</code>) will be added. We need
to invoke a function that knows how to add new networks to existing hosts.
</p></li>

<li><code>networks.{mac}.cidr</code> Similar to the previous example, however, in here we are listening on a
change of the <code>cidr</code> field inside an <span class="underline">already existing network</span> identifiable by <code>mac</code>. Now a
function that changes cidr values for existing networks in existing hosts whould be invoked.</li>

<li><code>field_a, field_b</code> this is an example of a compound signature, which is matched when a single
spec change has caused a difference in both <code>field_a</code> and <code>field_b</code> of a particular host.</li>

<li><p>
<code>field_a, inner.{id}.field_b</code> this is another example of a more complex signature, where a
single spec change causes a difference in both <code>field_a</code> and <code>field_b</code> which is an existing
compound object that lies inside a vector <code>inner</code> which is identified by <code>id</code>. Lets consider
the following example:
</p>
<pre class="example">
current host entity : {metadata {uuid "1234"
                                 kind "host"
                                 specVersion 3}
                       status   {field_a "value 1"
                                 inner   [{id 1
                                           field_b "value 2"}]}
                       spec     {field_a "value 1"
                                 inner   [{id 1
                                           field_b "value 2"}]}}

new spec change: {metadata {uuid "1234"
                                 kind "host"
                                 spec_version 4}
                   spec     {field_a "another val 1"               &lt;&lt; DIFF
                             inner   [{id 1
                                       field_b "another val 2"}]}} &lt;&lt; DIFF

</pre>

<p>
In this example, the SFS would match the spec change if it gets atomically swapped in
properly.
</p></li>
</ol>
</div>

<div id="outline-container-orgc639c6a" class="outline-5">
<h5 id="h-B64344FB-FD29-40E2-B7B8-336E36E010DC"><a id="orgc639c6a"></a><span class="section-number-5">3.3.6.1</span> Formal syntax of SFS</h5>
<div class="outline-text-5" id="text-h-B64344FB-FD29-40E2-B7B8-336E36E010DC">
<p>
The following is a formal syntax describing SFS:
</p>

<pre class="example">
S                = (Single-diff ',')* Single-diff
Single-diff      = Same-path Terminal
Terminal         = Different-field | Added-by-field | Removed-by-field
Same-path        = ((Key '.') | Id-into-vector)+
Id-into-vector   = '{' (Key '.')* Key '}' '.'
Key              = #'[a-zA-Z_]+'
Added-by-field   = '+' Id-field
Removed-by-field = '-' Id-field
Id-field         = '{' (Key '.')* Key '}'
Different-field  = Key
</pre>
</div>
</div>
</div>

<div id="outline-container-org8dd914b" class="outline-4">
<h4 id="h-7AB58359-9E2C-4AB3-BE19-05E0EE8EB8C3"><a id="org8dd914b"></a><span class="section-number-4">3.3.7</span> Intentful core</h4>
<div class="outline-text-4" id="text-h-7AB58359-9E2C-4AB3-BE19-05E0EE8EB8C3">
<p>
At the core of Papiea lies the intentful behavior mechanism. To establish this mechanism we need the following:
</p>
<ol class="org-ol">
<li>A representation of the user desire (<a href="#h-BAE5B042-453A-4E68-9829-DFEED95D9C4F">Spec</a>)</li>
<li>A representation of the system's state (<a href="#h-48BE09F4-1DFC-4110-9F9F-67399113C57C">Status</a>)</li>
<li>A way to find the differences between the desired and current state (<a href="#h-8D057AB6-1A0C-410C-9C39-66FFB86E234F">Differ</a>)</li>
<li>A way to act upon these differences in a deterministic, fault-tolerant way (<a href="#h-3FBDA8BC-C7F9-450F-B2A6-52A71B2953E8">Intentful Execution</a>)</li>
<li>A way to track the changes to completion (<a href="#h-8C40554A-6CC9-4526-881B-2BE3D0A70129">Intentful Tasks</a>)</li>
</ol>

<p>
Once these items are there, the intentful mechanism is rather trivial. Lets see the following pseudo-code:
</p>

<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">This is just conceptual to show how we are notified that a the</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">engine needs to look for a diff</span>
<span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #DCDCCC;">(</span><span style="color: #bb99b4;">entity</span>.<span style="color: #a3e0a0;">status_changed</span><span style="color: #BFEBBF;">()</span> || <span style="color: #bb99b4;">entity</span>.<span style="color: #a7aac0;">spec_changed</span><span style="color: #BFEBBF;">()</span> || <span style="color: #bb99b4;">entity</span>.<span style="color: #a7c0b9;">kind</span>.<span style="color: #a0d6e0;">timeout_reached</span><span style="color: #BFEBBF;">()</span><span style="color: #DCDCCC;">)</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Based on the intentful handlers registered by the provider</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">(namely, their SFS signatures), the constructed `differ` will</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">return the next diff to handle.</span>
    <span style="color: #c0afa7;">diff</span> = <span style="color: #bb99b4;">entity</span>.<span style="color: #a7c0b9;">kind</span>.<span style="color: #99bbb4;">differ</span>.<span style="color: #a7c0b9;">next_diff</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>.<span style="color: #bba699;">status</span>, <span style="color: #bb99b4;">entity</span>.<span style="color: #e0a0bc;">spec</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Look in Tasks, to see if there is a task that is not yet</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">resolved and is listening for this particular change.</span>
    <span style="color: #e0a0bc;">task</span> = <span style="color: #a7c0b9;">Tasks</span>.<span style="color: #99bbb4;">create_or_get</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>, <span style="color: #c0afa7;">diff</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">When the trigger for this change is a `spec change` the</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">returned task will usually be the task created by the spec</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">change request itself. When a status change or a timeout</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">trigger this event, a task may not be present and so a new,</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">implicit one, should be created.</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The task then sees if there is a currently working intentful</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">handler on this entity. If there is one currently working</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">(including making sure it is actually active), we stop</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">processing for this round</span>
    <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #BFEBBF;">(</span><span style="color: #e0a0bc;">task</span>.<span style="color: #a3e0a0;">is_intentful_handler_still_working</span><span style="color: #D0BF8F;">()</span> || <span style="color: #e0a0bc;">task</span>.<span style="color: #bba699;">is_running_a_procedure</span><span style="color: #D0BF8F;">()</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">{</span>
        <span style="color: #F0DFAF; font-weight: bold;">return</span>;
    <span style="color: #BFEBBF;">}</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">If nothing intentful is working and we are also not running</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">anything procedural, lets invoke the intentful handler to</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">settle the diff.</span>
    <span style="color: #a0d6e0;">ret</span> = <span style="color: #c0afa7;">diff</span>.<span style="color: #a7aac0;">invoke</span><span style="color: #BFEBBF;">()</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The value returned in `ret` is not the result of applying the</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">intentful handler to the entity. We are not waiting for the</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">intentful method to complete. The return value is merely a</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">signal that the handler has started working, and a uuid</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">representing this currently executing handler.</span>

    <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #BFEBBF;">(</span><span style="color: #a0d6e0;">ret</span>.<span style="color: #e0a0bc;">code</span><span style="color: #D0BF8F;">()</span> == <span style="color: #c0a7bd;">200</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">{</span>
        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">This should actually be done inside the provider_sdk to</span>
        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">address failures:</span>
        <span style="color: #e0a0bc;">task</span>.<span style="color: #b3c0a7;">set_working_intentful_handler</span><span style="color: #D0BF8F;">(</span><span style="color: #a0d6e0;">ret</span>.<span style="color: #c0a7bd;">handler_uuid_url</span><span style="color: #D0BF8F;">)</span>;
    <span style="color: #BFEBBF;">}</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
<div id="outline-container-orgc7bd2d6" class="outline-5">
<h5 id="h-8D057AB6-1A0C-410C-9C39-66FFB86E234F"><a id="orgc7bd2d6"></a><span class="section-number-5">3.3.7.1</span> Differ</h5>
<div class="outline-text-5" id="text-h-8D057AB6-1A0C-410C-9C39-66FFB86E234F">
<p>
The differ is at the core of identifying the next intentful command to be invoked. It is required for a few reasons:
</p>

<ol class="org-ol">
<li>A generic differ is too broad to fit an arbitrary data structure:
<ul class="org-ul">
<li><p>
There are cases where it is impossible to differentiate between an internal object being
changed and it being created or deleted. See the following example:
</p>

<p>
Consider the following entity <code>e</code>. Lets see two versions of it, <code>e_1</code> and <code>e_2</code>:
</p>
<pre class="example">
e1 = {x: [{a:1, b:2}]
e1 = {x: [{a:1, b:1}]
</pre>

<p>
In this example we have a two valid interpertations of what happened to the inner object inside <code>x</code>'s list:
</p>
<ol class="org-ol">
<li>The object identity is defined by the field <code>a</code>. In this case, the object <code>{a:1, b:2}</code>
simply changed its <code>b</code> component's value to <code>1</code>.</li>

<li>The object identity is defined by the field <code>b</code>. In this case, the object <code>{a:1, b:2}</code>
was removed, and a new object <code>{a:1, b:1}</code> was created</li>
</ol>

<p>
This is just a simple case, but we can make it as complicated as we would like.
</p></li>
</ul></li>

<li><p>
If the system does not have any method of resolving a diff, then we should not look for that
diff. Every field in spec needs to be able to handle a change of value, but that may not be
the case in reality. It could be a bug, a partial implementation, a field in spec for future
use etc. The best thing we could do with an unhandlable diff is print it.
</p>

<p>
Having the Differ look at all possible diff handlers a provider exports, we could have
automatic validation of which cases are handled, which cases are not handled and which cases
may have more than a single possible handler thus may cause inconsistencies in a diff
resolution.
</p></li>

<li>A generic differ may be reflective in nature and may suffer from degraded performance. A
compiled diff could use the knowledge of what could be handled and the priority to have
minimum number of branches to determine what handler will need to be invoked.</li>
</ol>

<p>
Due to the items described above, it is desirable to be able to compile the differ from the
signatures supplied by the provider, along with the dependency tree.
</p>

<p>
The following interface defines the compiler function as well as the <code>Differ</code> interface. Given a
kind, namely the intentful handlers signatures and the dependency tree, a <code>Differ</code> is built.
</p>
<div class="org-src-container">
<pre class="src src-typescript" id="org333a800">
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The sfss compiler function. </span>
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">compile_kind</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">sfss</span>: <span style="color: #DFAF8F;">sfs</span><span style="color: #BFEBBF;">[]</span>, <span style="color: #DFAF8F;">dep_tree</span>: <span style="color: #DFAF8F;">map</span>&lt;<span style="color: #DFAF8F;">sfs</span>, <span style="color: #DFAF8F;">sfs</span><span style="color: #BFEBBF;">[]</span>&gt;<span style="color: #DCDCCC;">)</span>: <span style="color: #DFAF8F;">Differ</span>;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">More concisely this could simply be:</span>
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">compile_kind</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">kind</span>: <span style="color: #DFAF8F;">Kind</span><span style="color: #DCDCCC;">)</span>: <span style="color: #b6a0e0;">Differ</span>;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The differ is used to locate a diff in an entity between the</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">current status and the desired state. </span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Differ</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the next diff from an entity based on the </span>
    <span style="color: #a7c0b9;">next_diff</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>:<span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #e0a0bc;">spec</span>: <span style="color: #c0afa7;">Spec</span>, <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #bba699;">Diff</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We could also get the entire list of diffs, ordered by the</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">original dependency tree</span>
    <span style="color: #99bbb4;">all_diffs</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>:<span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #e0a0bc;">spec</span>: <span style="color: #c0afa7;">Spec</span>, <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #bba699;">Diff</span><span style="color: #BFEBBF;">[]</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf35dd6e" class="outline-5">
<h5 id="h-3FBDA8BC-C7F9-450F-B2A6-52A71B2953E8"><a id="orgf35dd6e"></a><span class="section-number-5">3.3.7.2</span> Intentful Execution</h5>
<div class="outline-text-5" id="text-h-3FBDA8BC-C7F9-450F-B2A6-52A71B2953E8">
<p>
Once a <code>Diff</code> was constructed by the <code>Differ</code>, it can then execute the handler function on the
proper provider. 
</p>

<div class="org-src-container">
<pre class="src src-typescript" id="orgda7fce3"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The Diff structure captures a discovered diff in an entity as well</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">as the intentful action that may resolve such diff</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Diff</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The uri exposed by the provider which may handle this diff</span>
    <span style="color: #a0d6e0;">intentful_fn_uri</span>: <span style="color: #b3c0a7;">Provider_Callback_URL</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">If this intent handler has a name, we could use it</span>
    <span style="color: #bba699;">name</span>?: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The fields identified by this differ, their path and value.</span>
    <span style="color: #b6a0e0;">diff_fields</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #9999bb;">sfs</span>, <span style="color: #F0DFAF; font-weight: bold;">any</span>&gt;;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Actually invokes the intentful function</span>
    <span style="color: #a7aac0;">invoke</span><span style="color: #BFEBBF;">()</span>: <span style="color: #a6bb99;">Response</span>;
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
The <code>Diff</code> interface captures the fields that were matched by the sfs signatures (their path and
value), and the actual intentful behavior function url which is then used by the invoke
function.
</p>

<p>
This <code>invoke</code> function will result in the execution of the function registered using
<code>provider_sdk</code>'s <code>on</code> command. Invoke is essentially an RPC command (for now over HTTP but my be
implemented over other protocols) which only notifies the provider that it should start
executing that handler.
</p>
</div>
</div>
</div>

<div id="outline-container-org13023ec" class="outline-4">
<h4 id="h-6A154AB2-B69C-4C91-9338-198DB12F0672"><a id="org13023ec"></a><span class="section-number-4">3.3.8</span> Execution ID</h4>
<div class="outline-text-4" id="text-h-6A154AB2-B69C-4C91-9338-198DB12F0672">
<p>
In order for Papiea to keep track of the state of these decoupled execution paths, a simple
technique is employed. In the <code>provider_sdk</code>, when an intentful command has been invoked, the
system generates a unique uuid url which is then stored in perishable memory (meaning RAM,
without being persisted) and registerd in the task. The uuid url is directing to a specific
instance of the provider, meaning does not go through a load balancer.
</p>

<p>
This allows the Papiea engine to handle failures in providers. At any time, such as during
recovery or timeouts, Papiea could look at the task to see if any handler is still claimed to be
working. It then takes the handler's uuid url, and tries to invoke it. If it succeeds, that
means that the provider which is working on it still has that function running. If it failed it
means that the provider does not know about this handler, and thus it can be safely removed. 
</p>

<p>
Possible reasons why the provider will not recognize a uuid url:
</p>
<ol class="org-ol">
<li>The provider has crashed and recovered. Since the provider is stateless and this uuid is not
saved anywhere other than memory, it will not be familiar with that handler's uuid. This
would mean that the engine needs to re-ask for this operation, or other operations if this
operation partially succeeded and updated the status fields accordingly.</li>

<li>The intent engine has crashed. The provider may have finished executing just fine and wanted
to remove the uuid from the task. If the API it uses goes through Papiea and not directly, it
may fail to update the task. Once Papiea has recovered, the task will still seem to be active
and working on that handler, however, this mechanism would allow us to clear the task and
issue the next handler to work on to the providers.</li>

<li>Any failure in communication that causes the task not to get updated.</li>
</ol>

<p>
This is not a WAL, it simply a mechanism that allows Papiea and a provider to know if something
is still running or not, without having to to rely on waiting for anything to complete. Thus,
this is a method for decoupling a caller from having to continuously and uninterruptedly
listening to the callee.
</p>
</div>
</div>

<div id="outline-container-orgbd3c3f3" class="outline-4">
<h4 id="h-2D1D7EA5-3FF3-4536-BBCC-6CA2F59AFC53"><a id="orgbd3c3f3"></a><span class="section-number-4">3.3.9</span> Procedures Signatures</h4>
<div class="outline-text-4" id="text-h-2D1D7EA5-3FF3-4536-BBCC-6CA2F59AFC53">
<p>
Procedures are functions that providers can expose directly to an entity. These functions are
not intentful by design, and usually cannot be expressed in terms of a spec change.
</p>

<p>
For example, consider asking a host to reboot. The <code>Power</code> status of a host can either be <code>On</code>
or <code>Off</code>. However, a reboot is not a state of a machine, its a transition of the power state,
and thus cannot be expressed in terms of a desired state. It is said to be a <code>Procedure</code> that is
exposed on the host kind.
</p>

<p>
Similarly to SFS, procedures are also registring based on a signature, lets see an example:
</p>

<ul class="org-ul">
<li><p>
<code>hosts/{metadata.uuid}/reboot</code> - This signature refers to a <code>host</code> kind, will look a particular
host up by matching the given uuid to the <code>metadata.uuid</code> field of the host, and expose a
function called <code>reboot</code>. Seeing this signature will cause the engine to add a the following new api end point for the
host kind:
</p>
<pre class="example">
POST "/hosts/{uuid}/reboot" 
</pre>

<p>
Where <code>{uuid}</code> value will be matched against the host's <code>metadata.uuid</code>. Once a POST request for this
route has been received by the user, the request will be forwarded to the callback url provided at registration time.
</p></li>
</ul>
</div>

<div id="outline-container-org7a1e29c" class="outline-5">
<h5 id="h-33462E2A-9A02-4C95-ADFF-0C6CA0CAE12B"><a id="org7a1e29c"></a><span class="section-number-5">3.3.9.1</span> Procedure Signature struct</h5>
<div class="outline-text-5" id="text-h-33462E2A-9A02-4C95-ADFF-0C6CA0CAE12B">
<div class="org-src-container">
<pre class="src src-go" id="org82f725b"><span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">procedureSignature</span> <span style="color: #F0DFAF; font-weight: bold;">struct</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a6bb99;">signature</span> <span style="color: #c0afa7;">string</span>
    <span style="color: #e0a0bc;">parsedSignatureAst</span> ...
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org6d5ae05" class="outline-4">
<h4 id="h-7F774C3C-7E2E-44EA-84B9-21E57E4DF769"><a id="org6d5ae05"></a><span class="section-number-4">3.3.10</span> Understanding Deltas</h4>
<div class="outline-text-4" id="text-h-7F774C3C-7E2E-44EA-84B9-21E57E4DF769">
</div>
<div id="outline-container-orgf66dce1" class="outline-5">
<h5 id="h-A1BBF1FF-5B15-44B9-AF53-3FC413643E18"><a id="orgf66dce1"></a><span class="section-number-5">3.3.10.1</span> Matching SFSs to Deltas</h5>
<div class="outline-text-5" id="text-h-A1BBF1FF-5B15-44B9-AF53-3FC413643E18">
</div>
</div>
<div id="outline-container-org475d8f2" class="outline-5">
<h5 id="h-760CCC2A-F27B-4661-ACC7-02599C7DCDC7"><a id="org475d8f2"></a><span class="section-number-5">3.3.10.2</span> Determining Order</h5>
<div class="outline-text-5" id="text-h-760CCC2A-F27B-4661-ACC7-02599C7DCDC7">
</div>
</div>
</div>
<div id="outline-container-orgcfa1509" class="outline-4">
<h4 id="h-79A5E9CC-9D3C-41EE-A39C-DCF31ABF20FD"><a id="orgcfa1509"></a><span class="section-number-4">3.3.11</span> Provider</h4>
<div class="outline-text-4" id="text-h-79A5E9CC-9D3C-41EE-A39C-DCF31ABF20FD">
<p>
This section describes provider handling on Papiea's side. For the provider itself, please see <a href="#h-DCCF80B1-45AB-4C5D-BCF5-A433AC4D37C5">Provider Library</a>.
</p>

<p>
As described in <a href="#h-58B8746D-246B-437B-9457-04F667D64751">Provider facing APIs</a> section, providers interact with the intetful engine by
registring callbacks for two styles of actions:
</p>
<ul class="org-ul">
<li>Intentful actions - which are executed by analyzing their <a href="#h-0AFEADAD-0843-4364-971F-726CFA756F0A">Status Fields Signature</a></li>
<li>Procedural actions - which are executed by a user interaction</li>
</ul>

<p>
The following interface defines the registration mechanism for both kinds of actions:
</p>

<div class="org-src-container">
<pre class="src src-go" id="org166c5c7"><span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">provider_callbacks</span> <span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #93E0E3;">registerIntentfulCallback</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">sig</span> <span style="color: #a7c0b9;">sfsSignature</span>, <span style="color: #a6bb99;">callbackUrl</span> <span style="color: #c0afa7;">string</span><span style="color: #BFEBBF;">)</span> <span style="color: #e0a0bc;">err</span>
    <span style="color: #93E0E3;">registerProceduralCallback</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">sig</span> <span style="color: #c0a7bd;">procedureSignature</span>, <span style="color: #a6bb99;">callbackUrl</span> <span style="color: #c0afa7;">string</span><span style="color: #BFEBBF;">)</span> <span style="color: #e0a0bc;">err</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>

<p>
The following pseudocode describes how these may be implemented:
</p>

<div class="org-src-container">
<pre class="src src-go" id="org5b9db25"><span style="color: #F0DFAF; font-weight: bold;">func</span> <span style="color: #DCDCCC;">(</span><span style="color: #a0d6e0;">api_ctx</span> <span style="color: #7CB8BB;">papieaApiContext</span><span style="color: #DCDCCC;">)</span> <span style="color: #93E0E3;">registerIntentfulCallback</span><span style="color: #DCDCCC;">(</span><span style="color: #bb99b4;">sig</span> <span style="color: #7CB8BB;">sfsSignature</span>, <span style="color: #a6bb99;">callbackUrl</span> <span style="color: #7CB8BB;">string</span><span style="color: #DCDCCC;">)</span> <span style="color: #7CB8BB;">err</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a7aac0;">deltaAnalyzer</span>.<span style="color: #93E0E3;">register</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">sig</span>, <span style="color: #a6bb99;">callbackUrl</span><span style="color: #BFEBBF;">)</span>
<span style="color: #DCDCCC;">}</span>

<span style="color: #F0DFAF; font-weight: bold;">func</span> <span style="color: #DCDCCC;">(</span><span style="color: #a0d6e0;">api_ctx</span> <span style="color: #7CB8BB;">papiea_api_ctx</span><span style="color: #DCDCCC;">)</span> <span style="color: #93E0E3;">registerProceduralCallback</span><span style="color: #DCDCCC;">(</span><span style="color: #bb99b4;">sig</span> <span style="color: #7CB8BB;">procedureSignature</span>, <span style="color: #a6bb99;">callbackUrl</span> <span style="color: #7CB8BB;">string</span><span style="color: #DCDCCC;">)</span> <span style="color: #7CB8BB;">err</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a3e0a0;">procedures</span>.<span style="color: #93E0E3;">register</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">sig</span>, <span style="color: #a6bb99;">callbackUrl</span><span style="color: #BFEBBF;">)</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org6e85da6" class="outline-4">
<h4 id="h-00CF1105-6D19-4BFF-B82A-292EC8F658A9"><a id="org6e85da6"></a><span class="section-number-4">3.3.12</span> RBCA - test</h4>
<div class="outline-text-4" id="text-h-00CF1105-6D19-4BFF-B82A-292EC8F658A9">
</div>
</div>
<div id="outline-container-orga30191a" class="outline-4">
<h4 id="h-58305CF9-4FD0-480F-9E33-2704A3A7A5CE"><a id="orga30191a"></a><span class="section-number-4">3.3.13</span> Scalability and Reliability</h4>
<div class="outline-text-4" id="text-h-58305CF9-4FD0-480F-9E33-2704A3A7A5CE">
</div>
<div id="outline-container-org4f862cb" class="outline-5">
<h5 id="h-1E7F99CC-B4B5-41D7-9305-5C64BF9BC9AF"><a id="org4f862cb"></a><span class="section-number-5">3.3.13.1</span> Leader election</h5>
<div class="outline-text-5" id="text-h-1E7F99CC-B4B5-41D7-9305-5C64BF9BC9AF">
</div>
</div>
<div id="outline-container-org9c49083" class="outline-5">
<h5 id="h-E98DAE25-720F-4593-99F5-C3BEC60C6500"><a id="org9c49083"></a><span class="section-number-5">3.3.13.2</span> Fault tolerance</h5>
<div class="outline-text-5" id="text-h-E98DAE25-720F-4593-99F5-C3BEC60C6500">
</div>
<div id="outline-container-org976b79d" class="outline-6">
<h6 id="h-9B9442B5-2DA3-4A8A-9748-703AEBA44DC7"><a id="org976b79d"></a><span class="section-number-6">3.3.13.2.1</span> Dead Papiea Instance</h6>
<div class="outline-text-6" id="text-h-9B9442B5-2DA3-4A8A-9748-703AEBA44DC7">
</div>
</div>
<div id="outline-container-org369b767" class="outline-6">
<h6 id="h-9B4A9EFB-8CAE-48CA-AF41-0832D8D6ABC5"><a id="org369b767"></a><span class="section-number-6">3.3.13.2.2</span> Dead Provider</h6>
<div class="outline-text-6" id="text-h-9B4A9EFB-8CAE-48CA-AF41-0832D8D6ABC5">
</div>
</div>
</div>
</div>
<div id="outline-container-org5e6d0b4" class="outline-4">
<h4 id="h-3DE0B4AD-2DEB-42C1-9A59-02F509F51C8B"><a id="org5e6d0b4"></a><span class="section-number-4">3.3.14</span> Cleanup process</h4>
<div class="outline-text-4" id="text-h-3DE0B4AD-2DEB-42C1-9A59-02F509F51C8B">
<ul class="org-ul">
<li>automatic deletion?</li>
</ul>
</div>
</div>
<div id="outline-container-org6dd281f" class="outline-4">
<h4 id="h-87758AA9-A73F-4A88-AE6A-463CA2936DEA"><a id="org6dd281f"></a><span class="section-number-4">3.3.15</span> Auditing</h4>
<div class="outline-text-4" id="text-h-87758AA9-A73F-4A88-AE6A-463CA2936DEA">
</div>
</div>
</div>
<div id="outline-container-org1dbd6b4" class="outline-3">
<h3 id="h-8C40554A-6CC9-4526-881B-2BE3D0A70129"><a id="org1dbd6b4"></a><span class="section-number-3">3.4</span> Intentful Tasks&#xa0;&#xa0;&#xa0;<span class="tag"><span class="Continue_Fixing">Continue_Fixing</span></span></h3>
<div class="outline-text-3" id="text-h-8C40554A-6CC9-4526-881B-2BE3D0A70129">
<p>
Tasks are intentful in our intent engine. This means that a task defines an intent to "get
notified when a certain change request has completed". 
</p>

<p>
A new task may be created in the context of providing a new spec change or a status change. Since
a spec change is atomically swapped by the engine, a task for a particular spec change may fail
simply for not being able to atomically perform the swap (such as CAS failures in certain
models). Once a spec change has been properly and atomically swapped in, the task registers a
status change listener using <a href="#h-0AFEADAD-0843-4364-971F-726CFA756F0A">SFS - Status Fields Signature</a>. It will listen on all the fields that
the spec change has requested to change. On every field, the following actions can happen:
</p>
<ol class="org-ol">
<li>The field will get updated to the value that the spec change was requesting
<ul class="org-ul">
<li>Once this happens, this field is marked as successfully being fulfilled, the context of the
status change may be logged for later auditing and the SFS for this field is stopped</li>
</ul></li>
<li>The field will get updated to a value that is <b>other</b> than the spec change was requesting
<ul class="org-ul">
<li>If this happens, the task will look to see if the spec version of the entity has increased
<ul class="org-ul">
<li>If it has, this field will be marked as <b>outdated</b> and teh SFS for this field is
stopped. A reference to the outdating spec change may be maintained for later auditing.</li>
<li>If it still has the same spec version as the task, the task will not get updated</li>
</ul></li>
</ul></li>
</ol>

<p>
Using this scheme, the task is said to be complete if there are no more active SFS listeners. It
may be completed in three ways:
</p>
<ol class="org-ol">
<li>Completed Successfully - All fields were set to the spec value at some point after the spec
change was issued</li>
<li>Completed Partially - Some fields were set to the spec value, and some were not due to a newer
spec version</li>
<li>Failed - non of the fields was changed to the given spec values, and there is already a newer
spec version</li>
</ol>

<p>
As long as there are still active SFS listeners in the task, it will be <b>pending</b>. It can show
progress in terms of how many fields are left of the total fields. The intent engine will have to
query pending tasks periodically to see if work has to be restarted.
</p>

<ul class="org-ul">
<li>TODO: What if a before a spec version has made a change to modify
a field's value, a new spec change arrived that reverted the
field's value to its value before the first spec change? This
will cause status to never be updated because there is no
difference between spec and status, but there is a task still
listening.. Need to think about this</li>
</ul>

<div class="org-src-container">
<pre class="src src-typescript" id="orgc36a765"><span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">new_intentful_task</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">papiea</span>: <span style="color: #DFAF8F;">Papiea</span>, <span style="color: #DFAF8F;">entity</span>: <span style="color: #DFAF8F;">Entity_Reference</span>, <span style="color: #DFAF8F;">kind</span>: <span style="color: #DFAF8F;">Kind</span>, <span style="color: #DFAF8F;">spec</span>: <span style="color: #DFAF8F;">Spec</span><span style="color: #DCDCCC;">)</span>: <span style="color: #a7aac0;">Task</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the status of the entity we are trying to change.</span>
    <span style="color: #bba699;">status</span> = <span style="color: #a7c0b9;">papiea</span>.<span style="color: #99bbb4;">status_db</span>.<span style="color: #a6bb99;">get_status</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Calculate the delta between the spec and the status. calc_delta</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">will take into consideration all registered SFS for the</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">entity's kind in order to know how to diff on vector</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">elements. See more details in calc_delta. Each delta found will</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">record the corresponding SFS that could is registered which</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">should be able to resolve the diff</span>
    <span style="color: #bb99b4;">deltas</span> = <span style="color: #a7c0b9;">kind</span>.<span style="color: #99bbb4;">differ</span>.<span style="color: #e0d0a0;">all_difs</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>, <span style="color: #e0a0bc;">spec</span>, <span style="color: #bba699;">status</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">we are the task</span>
    <span style="color: #e0a0bc;">task</span> = <span style="color: #F0DFAF; font-weight: bold;">new</span> <span style="color: #7CB8BB;">Task</span><span style="color: #BFEBBF;">()</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Register all the relevant deltas we could listen on</span>
    <span style="color: #e0a0bc;">task</span>.<span style="color: #9999bb;">register_delta</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">delta</span><span style="color: #BFEBBF;">)</span>;

    <span style="color: #F0DFAF; font-weight: bold;">for</span> <span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">field</span> <span style="color: #F0DFAF; font-weight: bold;">in</span> <span style="color: #bba699;">deltaho</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">{</span>
        <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">TBD: define on, define context</span>
        <span style="color: #e0a0bc;">fieldListener</span> = <span style="color: #a7c0b9;">papiea</span>.<span style="color: #e0a0bc;">on</span><span style="color: #D0BF8F;">(</span><span style="color: #bb99b4;">field</span>.<span style="color: #9999bb;">sfs</span>, <span style="color: #a0d6e0;">func</span><span style="color: #93E0E3;">(</span><span style="color: #e0a0bc;">context</span>, <span style="color: #e0d0a0;">updatedEntity</span> <span style="color: #e0d0a0;">entityReference</span>, <span style="color: #bba699;">status</span> <span style="color: #bba699;">status</span><span style="color: #93E0E3;">){</span>
            <span style="color: #a7c0b9;">newValue</span> = <span style="color: #bba699;">status</span>.<span style="color: #F0DFAF; font-weight: bold;">get</span><span style="color: #9FC59F;">(</span><span style="color: #bb99b4;">field</span>.<span style="color: #a3e0a0;">path</span><span style="color: #9FC59F;">)</span>
            <span style="color: #99bbb4;">specValue</span> = <span style="color: #e0a0bc;">spec</span>.<span style="color: #F0DFAF; font-weight: bold;">get</span><span style="color: #9FC59F;">(</span><span style="color: #bb99b4;">field</span>.<span style="color: #a3e0a0;">path</span><span style="color: #9FC59F;">)</span>

            <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span><span style="color: #a7c0b9;">newValue</span> == <span style="color: #99bbb4;">specValue</span><span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">{</span>
                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Update the task that this field in the delta is a success</span>
                <span style="color: #e0a0bc;">task</span>.<span style="color: #a7aac0;">updateFieldStatus</span><span style="color: #94BFF3;">(</span><span style="color: #bb99b4;">field</span>, <span style="color: #CC9393;">"Success"</span><span style="color: #94BFF3;">)</span>

                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Stopping this listener</span>
                <span style="color: #e0a0bc;">task</span>.<span style="color: #99bbb4;">removeFieldListener</span><span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">this</span><span style="color: #94BFF3;">)</span>
            <span style="color: #9FC59F;">}</span>
            <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #9FC59F;">(</span><span style="color: #bb99b4;">entity</span>.<span style="color: #99bbb4;">metadata</span>.<span style="color: #e0d0a0;">specVersion</span> == <span style="color: #e0d0a0;">updatedEntity</span>.<span style="color: #99bbb4;">metadata</span>.<span style="color: #e0d0a0;">specVersion</span><span style="color: #9FC59F;">)</span> <span style="color: #9FC59F;">{</span>
                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We got a different value, but still on the same spec version, dont do anything yet</span>
                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Add to audit</span>
                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Perhaps note this in some TTL</span>
            <span style="color: #9FC59F;">}</span>
            <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #9FC59F;">{</span>
                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We got a different value AND the spec version has increased (it can only increase)</span>

                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">update the task that this field is outdated by a particular spec version</span>
                <span style="color: #e0a0bc;">task</span>.<span style="color: #a7aac0;">updateFieldStatus</span><span style="color: #94BFF3;">(</span><span style="color: #bb99b4;">field</span>, <span style="color: #CC9393;">"Outdated by "</span> + <span style="color: #e0d0a0;">updatedEntity</span>.<span style="color: #99bbb4;">metadata</span>.<span style="color: #e0d0a0;">specVersion</span><span style="color: #94BFF3;">)</span>

                <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Stopping this listener</span>
                <span style="color: #e0a0bc;">task</span>.<span style="color: #99bbb4;">removeFieldListener</span><span style="color: #94BFF3;">(</span><span style="color: #F0DFAF; font-weight: bold;">this</span><span style="color: #94BFF3;">)</span>
            <span style="color: #9FC59F;">}</span>

            <span style="color: #e0a0bc;">task</span>.<span style="color: #bb99b4;">verifyCompletness</span><span style="color: #9FC59F;">()</span>
        <span style="color: #93E0E3;">}</span><span style="color: #D0BF8F;">)</span>

        <span style="color: #e0a0bc;">task</span>.<span style="color: #c0afa7;">addFieldListener</span><span style="color: #D0BF8F;">(</span><span style="color: #e0a0bc;">fieldListener</span><span style="color: #D0BF8F;">)</span>
    <span style="color: #BFEBBF;">}</span>
<span style="color: #DCDCCC;">}</span>

<span style="color: #a0d6e0;">func</span> <span style="color: #DCDCCC;">(</span><span style="color: #a7c0b9;">papiea</span> <span style="color: #a7c0b9;">papiea</span><span style="color: #DCDCCC;">)</span> <span style="color: #bb99b4;">verifyCompletness</span><span style="color: #DCDCCC;">()</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #BFEBBF;">(</span><span style="color: #e0a0bc;">task</span>.<span style="color: #a6bb99;">noMoreFieldListeners</span><span style="color: #D0BF8F;">()</span><span style="color: #BFEBBF;">)</span> <span style="color: #BFEBBF;">{</span>
        <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span><span style="color: #e0a0bc;">task</span>.<span style="color: #b3c0a7;">specDidNotRegister</span><span style="color: #93E0E3;">()</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
            <span style="color: #e0a0bc;">task</span>.<span style="color: #a0d6e0;">setStatus</span><span style="color: #93E0E3;">(</span><span style="color: #CC9393;">"Spec did not manage to be atomically committed. Try again."</span><span style="color: #93E0E3;">)</span>
        <span style="color: #D0BF8F;">}</span>
        <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #F0DFAF; font-weight: bold;">if</span> <span style="color: #D0BF8F;">(</span><span style="color: #e0a0bc;">task</span>.<span style="color: #c0afa7;">hasFailedFields</span><span style="color: #93E0E3;">()</span><span style="color: #D0BF8F;">)</span> <span style="color: #D0BF8F;">{</span>
            <span style="color: #e0a0bc;">task</span>.<span style="color: #a0d6e0;">setStatus</span><span style="color: #93E0E3;">(</span><span style="color: #CC9393;">"Partially Completed"</span><span style="color: #93E0E3;">)</span>
        <span style="color: #D0BF8F;">}</span> <span style="color: #F0DFAF; font-weight: bold;">else</span> <span style="color: #D0BF8F;">{</span>
            <span style="color: #e0a0bc;">task</span>.<span style="color: #a0d6e0;">setStatus</span><span style="color: #93E0E3;">(</span><span style="color: #CC9393;">"Completed Successfully"</span><span style="color: #93E0E3;">)</span>
        <span style="color: #D0BF8F;">}</span>
    <span style="color: #BFEBBF;">}</span>
<span style="color: #DCDCCC;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgcbe1de8" class="outline-3">
<h3 id="h-DCCF80B1-45AB-4C5D-BCF5-A433AC4D37C5"><a id="orgcbe1de8"></a><span class="section-number-3">3.5</span> Provider Library</h3>
<div class="outline-text-3" id="text-h-DCCF80B1-45AB-4C5D-BCF5-A433AC4D37C5">
</div>
<div id="outline-container-orgbfb4745" class="outline-4">
<h4 id="h-89837841-3C06-4788-ABC5-D3B4BE918654"><a id="orgbfb4745"></a><span class="section-number-4">3.5.1</span> Define Entity Model</h4>
<div class="outline-text-4" id="text-h-89837841-3C06-4788-ABC5-D3B4BE918654">
</div>
<div id="outline-container-orge93c6a2" class="outline-5">
<h5 id="h-9E4F86C1-5088-4875-B037-107AD12A73CB"><a id="orge93c6a2"></a><span class="section-number-5">3.5.1.1</span> YAML</h5>
<div class="outline-text-5" id="text-h-9E4F86C1-5088-4875-B037-107AD12A73CB">
</div>
</div>
<div id="outline-container-org9f49487" class="outline-5">
<h5 id="h-AC6A2914-694E-4B7F-AB99-F915E1B7A0B2"><a id="org9f49487"></a><span class="section-number-5">3.5.1.2</span> CRUD</h5>
<div class="outline-text-5" id="text-h-AC6A2914-694E-4B7F-AB99-F915E1B7A0B2">
</div>
</div>
</div>
<div id="outline-container-orgc9dd1bc" class="outline-4">
<h4 id="h-610E1433-DBCF-4169-974D-47A63004F6CA"><a id="orgc9dd1bc"></a><span class="section-number-4">3.5.2</span> Initialize</h4>
<div class="outline-text-4" id="text-h-610E1433-DBCF-4169-974D-47A63004F6CA">
</div>
</div>
<div id="outline-container-org5cdb59c" class="outline-4">
<h4 id="h-576FB59C-5E14-41BB-9D46-253E63A8E082"><a id="org5cdb59c"></a><span class="section-number-4">3.5.3</span> Callback Mechanism</h4>
<div class="outline-text-4" id="text-h-576FB59C-5E14-41BB-9D46-253E63A8E082">
</div>
</div>
<div id="outline-container-org1434ff6" class="outline-4">
<h4 id="h-7009B3C1-3D1B-465A-93ED-F35A5AB3CF4D"><a id="org1434ff6"></a><span class="section-number-4">3.5.4</span> Running Effect Validator</h4>
<div class="outline-text-4" id="text-h-7009B3C1-3D1B-465A-93ED-F35A5AB3CF4D">
</div>
</div>
<div id="outline-container-org46cdb3f" class="outline-4">
<h4 id="h-A1199B4C-F994-4548-9A5B-668723B359C2"><a id="org46cdb3f"></a><span class="section-number-4">3.5.5</span> Status Changes Handlers</h4>
<div class="outline-text-4" id="text-h-A1199B4C-F994-4548-9A5B-668723B359C2">
</div>
<div id="outline-container-orgd0ab96a" class="outline-5">
<h5 id="h-E991437E-7322-4F46-92DF-6895F8C7EAC1"><a id="orgd0ab96a"></a><span class="section-number-5">3.5.5.1</span> Registring</h5>
<div class="outline-text-5" id="text-h-E991437E-7322-4F46-92DF-6895F8C7EAC1">
</div>
</div>
<div id="outline-container-org13eccea" class="outline-5">
<h5 id="h-AA340191-E756-4642-B9F5-426FFEFF4ECB"><a id="org13eccea"></a><span class="section-number-5">3.5.5.2</span> Running using context</h5>
<div class="outline-text-5" id="text-h-AA340191-E756-4642-B9F5-426FFEFF4ECB">
</div>
</div>
</div>
<div id="outline-container-org8e2ebe4" class="outline-4">
<h4 id="h-5511BB0C-438F-4EF5-96C3-86642690C568"><a id="org8e2ebe4"></a><span class="section-number-4">3.5.6</span> Procedures</h4>
<div class="outline-text-4" id="text-h-5511BB0C-438F-4EF5-96C3-86642690C568">
</div>
<div id="outline-container-orgda79e2f" class="outline-5">
<h5 id="h-CCFBCE3C-C7DB-48C9-B35D-0201EB13D429"><a id="orgda79e2f"></a><span class="section-number-5">3.5.6.1</span> Registring</h5>
<div class="outline-text-5" id="text-h-CCFBCE3C-C7DB-48C9-B35D-0201EB13D429">
</div>
</div>
<div id="outline-container-org2ddbd81" class="outline-5">
<h5 id="h-9B305BB6-112D-4D39-9956-60AE424BBCDA"><a id="org2ddbd81"></a><span class="section-number-5">3.5.6.2</span> Running using context</h5>
<div class="outline-text-5" id="text-h-9B305BB6-112D-4D39-9956-60AE424BBCDA">
</div>
</div>
</div>
<div id="outline-container-org687351b" class="outline-4">
<h4 id="h-D6094197-1C78-45BC-9CDD-9E3555897591"><a id="org687351b"></a><span class="section-number-4">3.5.7</span> Example Provider</h4>
<div class="outline-text-4" id="text-h-D6094197-1C78-45BC-9CDD-9E3555897591">
</div>
</div>
</div>
</div>

<div id="outline-container-orga26bc2e" class="outline-2">
<h2 id="h-738F973C-D059-4099-BAE9-94F6882FE791"><a id="orga26bc2e"></a><span class="section-number-2">4</span> Full files</h2>
<div class="outline-text-2" id="text-h-738F973C-D059-4099-BAE9-94F6882FE791">
</div>
<div id="outline-container-org3df4284" class="outline-3">
<h3 id="h-69C25B02-B7F5-4567-B14F-B33564795341"><a id="org3df4284"></a><span class="section-number-3">4.1</span> Core definitions</h3>
<div class="outline-text-3" id="text-h-69C25B02-B7F5-4567-B14F-B33564795341">
</div>
<div id="outline-container-org74cfd72" class="outline-4">
<h4 id="h-7CD37704-4271-4745-A480-217D94B04ED7"><a id="org74cfd72"></a><span class="section-number-4">4.1.1</span> /src/core.ts</h4>
<div class="outline-text-4" id="text-h-7CD37704-4271-4745-A480-217D94B04ED7">
<div class="org-src-container">
<pre class="src src-typescript">
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-CE60E8C5-765E-4454-A5F9-2780A2464889][metadata-struct]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Metadata</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Identity fields</span>
    <span style="color: #c0afa7;">uuid</span>: <span style="color: #b3c0a7;">uuid4</span>;
    <span style="color: #a7c0b9;">kind</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
    <span style="color: #c0a7bd;">spec_version</span>: <span style="color: #F0DFAF; font-weight: bold;">number</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Additional fields</span>
    <span style="color: #e0a0bc;">created_at</span>: <span style="color: #a3e0a0;">timestamp</span>;
    <span style="color: #e0d0a0;">delete_at</span>: <span style="color: #a3e0a0;">timestamp</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">metadata-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-BAE5B042-453A-4E68-9829-DFEED95D9C4F][spec-struct]]</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Spec</span> = <span style="color: #F0DFAF; font-weight: bold;">any</span>;
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">spec-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-48BE09F4-1DFC-4110-9F9F-67399113C57C][status-struct]]</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Status</span> = <span style="color: #F0DFAF; font-weight: bold;">any</span>;
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">status-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-122002C8-E0B4-40F9-A48B-E75FDA28AAC6][entity-struct]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Entity</span> <span style="color: #DCDCCC;">{</span>
  <span style="color: #99bbb4;">metadata</span>: <span style="color: #b6a0e0;">Metadata</span>;
  <span style="color: #e0a0bc;">spec</span>: <span style="color: #c0afa7;">Spec</span>;
  <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span>
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">entity-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-1A45850B-821C-439F-BE1C-5CA5FF2B7A79][kind-struct]]</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Intentful signature</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">SFS</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Provider_Callback_URL</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Intentful_Signature</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a6bb99;">signature</span>: <span style="color: #a3e0a0;">SFS</span>;
    <span style="color: #b6a0e0;">compiled_signature</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>
    <span style="color: #a3e0a0;">function_callback</span>: <span style="color: #b3c0a7;">Provider_Callback_URL</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Store a struct description parsed from Swagger Model YAML</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">Data_Description</span> = <span style="color: #F0DFAF; font-weight: bold;">any</span>;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We may want to support different execution strategies. For now we</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">can only halt intentful execution for the duration of the</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">procedural call</span>
<span style="color: #F0DFAF; font-weight: bold;">enum</span> <span style="color: #7CB8BB;">Procedural_Execution_Strategy</span> <span style="color: #DCDCCC;">{</span><span style="color: #99bbb4;">Halt_Intentful</span><span style="color: #DCDCCC;">}</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Procedural_Signature</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The name of the procedure to be exported by the engine.</span>
    <span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The representation of the data to be passed to this procedure</span>
    <span style="color: #e0a0bc;">argument</span>: <span style="color: #c0afa7;">Data_Description</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The automatically generated validator</span>
    <span style="color: #a7aac0;">arg_validator_fn</span>: <span style="color: #BFEBBF;">(</span><span style="color: #b6a0e0;">arg</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The representation of the data to be returned from this procedure</span>
    <span style="color: #a0d6e0;">result</span>: <span style="color: #c0afa7;">Data_Description</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The automatically generated validator</span>
    <span style="color: #bb99b4;">result_validator_fn</span>: <span style="color: #BFEBBF;">(</span><span style="color: #a0d6e0;">res</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Does the engine pauses all intentful operation invocations for</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">the duration of the procedural call</span>
    <span style="color: #a0d6e0;">execution_strategy</span>: <span style="color: #99bbb4;">Procedural_Execution_Strategy</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Action url into the provider</span>
    <span style="color: #a3e0a0;">procedure_callback</span>: <span style="color: #b3c0a7;">Provider_Callback_URL</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Kind</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The name of the kind, and its plural form for proper REST naming</span>
    <span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
    <span style="color: #e0d0a0;">name_plural</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">//// </span><span style="color: #7F9F7F;">Entity structure</span>
    <span style="color: #b6a0e0;">kind_structure</span>: <span style="color: #c0afa7;">Data_Description</span>;
    <span style="color: #a3e0a0;">validator_fn</span>: <span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>:<span style="color: #bb99b4;">entity</span><span style="color: #BFEBBF;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
    <span style="color: #e0a0bc;">semantic_validator_fn</span>?: <span style="color: #b3c0a7;">Provider_Callback_URL</span>; 

    <span style="color: #5F7F5F;">//// </span><span style="color: #7F9F7F;">Intentful behavior</span>
    <span style="color: #bb99b4;">intentful_signatures</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #a3e0a0;">SFS</span>, <span style="color: #a0d6e0;">Intentful_Signatures</span>&gt;;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Every sfs lists the sfs's it has to execute before</span>
    <span style="color: #e0d0a0;">dependency_tree</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #a3e0a0;">SFS</span>, <span style="color: #a3e0a0;">SFS</span><span style="color: #BFEBBF;">[]</span>&gt;;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The compiled Differ</span>
    <span style="color: #99bbb4;">differ</span>: <span style="color: #b6a0e0;">Differ</span>;

    <span style="color: #5F7F5F;">//// </span><span style="color: #7F9F7F;">Procedural behavior</span>
    <span style="color: #a3e0a0;">procedures</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a3e0a0;">Procedural_Signature</span>&gt;;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">kind-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-72D813C8-1AEE-449B-BE2E-0FB4FC53FD5A][entity-reference-struct]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Entity_Reference</span>  <span style="color: #DCDCCC;">{</span>
    <span style="color: #c0afa7;">uuid</span>: <span style="color: #b3c0a7;">uuid4</span>;
    <span style="color: #a7c0b9;">kind</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">This field is optional and is only used help the user identify</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">what this reference is pointing to. </span>
    <span style="color: #bba699;">name</span>?: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">entity-reference-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-97314854-673B-4CD4-874A-B9C1F9AE6B44][provider-desc-struct]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Provider</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">A unique identifier where all kinds will be under this prefix</span>
    <span style="color: #a0d6e0;">prefix</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;
    <span style="color: #e0d0a0;">version</span>: <span style="color: #9999bb;">Version</span>;
    <span style="color: #b6a0e0;">kinds</span>: <span style="color: #99bbb4;">Kind</span><span style="color: #BFEBBF;">[]</span>
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">provider-desc-struct ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-3D76A395-5D87-495F-9138-9373F4CC859C][papiea-interface]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Papiea</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">api is the mechanism which adds REST endpoints to Papiea.</span>
    <span style="color: #a7aac0;">api</span>: <span style="color: #bba699;">route</span>;
    <span style="color: #a0d6e0;">prefix</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #9999bb;">statusDb</span>: <span style="color: #c0afa7;">Status_DB</span>;
    <span style="color: #bba699;">specsDb</span>: <span style="color: #e0a0bc;">Spec_DB</span>;
    <span style="color: #a7c0b9;">providersDb</span>: <span style="color: #c0afa7;">Providers_DB</span>;
<span style="color: #DCDCCC;">}</span> 
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">papiea-interface ends here</span>

</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6e51581" class="outline-3">
<h3 id="h-895B51BC-E9D2-4277-88DA-1D57403DAD85"><a id="org6e51581"></a><span class="section-number-3">4.2</span> Databases</h3>
<div class="outline-text-3" id="text-h-895B51BC-E9D2-4277-88DA-1D57403DAD85">
</div>
<div id="outline-container-org9248300" class="outline-4">
<h4 id="h-3E385A6D-FE01-4147-AC9E-8F814FFF663F"><a id="org9248300"></a><span class="section-number-4">4.2.1</span> /src/databases/spec<sub>db</sub><sub>interface.ts</sub></h4>
<div class="outline-text-4" id="text-h-3E385A6D-FE01-4147-AC9E-8F814FFF663F">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-C485E97F-9BAD-4B12-820E-02E408231E6E][spec-db-interface]]</span>

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Spec_DB</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Tries to update the spec. Succeeds only if the spec_version</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">field in metadata is currently equals to the one on record. The</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">implementation needs to CAS the spec_version to the increment</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">of itself, and return the new metadata with the new</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">spec_version and the new CASed in spec.</span>
    <span style="color: #a7c0b9;">update_spec</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>: <span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #e0a0bc;">spec</span>:<span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">)</span>:<span style="color: #BFEBBF;">[</span><span style="color: #F0DFAF; font-weight: bold;">boolean</span>, <span style="color: #b6a0e0;">Metadata</span>, <span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">]</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the spec of a particular entity from the db. Returns both</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">current metadata and the spec of that entity.</span>
    <span style="color: #c0afa7;">get_spec</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>: <span style="color: #e0d0a0;">Entity_Reference</span><span style="color: #BFEBBF;">)</span>:<span style="color: #BFEBBF;">[</span><span style="color: #b6a0e0;">Metadata</span>, <span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">]</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">List all specs that have their fields match the ones given in</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">fields_map. E.g. we could look for all specs for `vm` kind that</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">have a certain ip:</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">list_specs({"metadata": {"kind": "vm"},</span>
    <span style="color: #5F7F5F;">//             </span><span style="color: #7F9F7F;">"spec":     {"ip":   "10.0.0.10"}})</span>
    <span style="color: #5F7F5F;">//</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We could come up with command such as greater-than etc at some</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">later point, or we could use a similar dsl to mongodb search</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">dsl.</span>
    <span style="color: #a7aac0;">list_specs</span><span style="color: #BFEBBF;">(</span><span style="color: #c0a7bd;">fields_map</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>: <span style="color: #BFEBBF;">[</span><span style="color: #b6a0e0;">Metadata</span>, <span style="color: #c0afa7;">Spec</span><span style="color: #BFEBBF;">][]</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">spec-db-interface ends here</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdbc0f69" class="outline-4">
<h4 id="h-B6BFED5E-E21F-48F2-BDB6-D7DBBB148401"><a id="orgdbc0f69"></a><span class="section-number-4">4.2.2</span> /src/databases/status<sub>db</sub><sub>interface.ts</sub></h4>
<div class="outline-text-4" id="text-h-B6BFED5E-E21F-48F2-BDB6-D7DBBB148401">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-7E3D79F1-DC44-4C08-8EA0-CC683CEB36BA][status-db-interface]]</span>

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Status_DB</span><span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Update the status in the status db. As long as the input is</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">correct this always succeeds.</span>
    <span style="color: #c0a7bd;">update_status</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>:<span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #bba699;">status</span>:<span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Gets the status of a particular entity from the db. Returns</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">both current metadata and status of the entity.</span>
    <span style="color: #a6bb99;">get_status</span><span style="color: #BFEBBF;">(</span><span style="color: #a3e0a0;">entity_ref</span>:<span style="color: #e0d0a0;">Entity_Reference</span><span style="color: #BFEBBF;">)</span>:<span style="color: #9999bb;">Status</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">List all status that have their fields match the ones given in</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">fields_map. E.g. we could look for all specs for `vm` kind that</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">have a certain ip:</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">list_status({"metadata": {"kind": "vm"},</span>
    <span style="color: #5F7F5F;">//              </span><span style="color: #7F9F7F;">"status":   {"ip":   "10.0.0.10"}})</span>
    <span style="color: #5F7F5F;">//</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We could come up with command such as greater-than etc at some</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">later point, or we could use a similar dsl to mongodb search</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">dsl.</span>
    <span style="color: #9999bb;">list_status</span><span style="color: #BFEBBF;">(</span><span style="color: #c0a7bd;">fields_map</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>: <span style="color: #BFEBBF;">[</span><span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">][]</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">status-db-interface ends here</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4dcc435" class="outline-4">
<h4 id="h-3219E22A-305C-4450-B2DD-D4C0D8C9CE16"><a id="org4dcc435"></a><span class="section-number-4">4.2.3</span> /src/databases/providers<sub>db</sub><sub>interface.ts</sub></h4>
<div class="outline-text-4" id="text-h-3219E22A-305C-4450-B2DD-D4C0D8C9CE16">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-48C4E5F4-E98F-4DAA-8DB7-1576C1EC3B09][providers-db-interface]]</span>

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Providers_DB</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Register a new provider with the intent engine</span>
    <span style="color: #e0d0a0;">register_provider</span><span style="color: #BFEBBF;">(</span><span style="color: #e0d0a0;">provider</span>: <span style="color: #e0a0bc;">Provider</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;

    <span style="color: #5F7F5F;">//</span><span style="color: #7F9F7F;">Upgrade a provider - This should be in the admin?</span>
    <span style="color: #5F7F5F;">//</span><span style="color: #7F9F7F;">upgrade_provider(from_provider: uuid4, to: providerDescription): Task;</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">get a provider</span>
    <span style="color: #b3c0a7;">get_provider</span><span style="color: #BFEBBF;">(</span><span style="color: #b3c0a7;">provider_prefix</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #e0d0a0;">version</span>?: <span style="color: #9999bb;">Version</span><span style="color: #BFEBBF;">)</span>: <span style="color: #e0a0bc;">Provider</span><span style="color: #BFEBBF;">[]</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">List all registered providers</span>
    <span style="color: #bba699;">list_providers</span><span style="color: #BFEBBF;">()</span>: <span style="color: #e0a0bc;">Provider</span><span style="color: #BFEBBF;">[]</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Removes and de-registers a provider from the intent engine</span>
    <span style="color: #bba699;">delete_provider</span><span style="color: #BFEBBF;">(</span><span style="color: #e0d0a0;">provider_uuid</span>: <span style="color: #b3c0a7;">uuid4</span><span style="color: #BFEBBF;">)</span>: <span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">providers-db-interface ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcf51e7c" class="outline-3">
<h3 id="h-18B3FC53-9C2C-4F04-B851-03488558444E"><a id="orgcf51e7c"></a><span class="section-number-3">4.3</span> Differ</h3>
<div class="outline-text-3" id="text-h-18B3FC53-9C2C-4F04-B851-03488558444E">
</div>
<div id="outline-container-orgca7070b" class="outline-4">
<h4 id="h-535177EF-5CF0-4663-B7E4-FDB12EEA9D64"><a id="orgca7070b"></a><span class="section-number-4">4.3.1</span> /src/intentful<sub>core</sub>/differ<sub>interface.ts</sub></h4>
<div class="outline-text-4" id="text-h-535177EF-5CF0-4663-B7E4-FDB12EEA9D64">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-8D057AB6-1A0C-410C-9C39-66FFB86E234F][Differ-interface]]</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The sfss compiler function. </span>
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">compile_kind</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">sfss</span>: <span style="color: #DFAF8F;">sfs</span><span style="color: #BFEBBF;">[]</span>, <span style="color: #DFAF8F;">dep_tree</span>: <span style="color: #DFAF8F;">map</span>&lt;<span style="color: #DFAF8F;">sfs</span>, <span style="color: #DFAF8F;">sfs</span><span style="color: #BFEBBF;">[]</span>&gt;<span style="color: #DCDCCC;">)</span>: <span style="color: #DFAF8F;">Differ</span>;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">More concisely this could simply be:</span>
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">compile_kind</span><span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">kind</span>: <span style="color: #DFAF8F;">Kind</span><span style="color: #DCDCCC;">)</span>: <span style="color: #b6a0e0;">Differ</span>;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The differ is used to locate a diff in an entity between the</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">current status and the desired state. </span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Differ</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Get the next diff from an entity based on the </span>
    <span style="color: #a7c0b9;">next_diff</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>:<span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #e0a0bc;">spec</span>: <span style="color: #c0afa7;">Spec</span>, <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #bba699;">Diff</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">We could also get the entire list of diffs, ordered by the</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">original dependency tree</span>
    <span style="color: #99bbb4;">all_diffs</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">entity</span>:<span style="color: #e0d0a0;">Entity_Reference</span>, <span style="color: #e0a0bc;">spec</span>: <span style="color: #c0afa7;">Spec</span>, <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #bba699;">Diff</span><span style="color: #BFEBBF;">[]</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Differ-interface ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-3FBDA8BC-C7F9-450F-B2A6-52A71B2953E8][Diff-interface]]</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The Diff structure captures a discovered diff in an entity as well</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">as the intentful action that may resolve such diff</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Diff</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The uri exposed by the provider which may handle this diff</span>
    <span style="color: #a0d6e0;">intentful_fn_uri</span>: <span style="color: #b3c0a7;">Provider_Callback_URL</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">If this intent handler has a name, we could use it</span>
    <span style="color: #bba699;">name</span>?: <span style="color: #F0DFAF; font-weight: bold;">string</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">The fields identified by this differ, their path and value.</span>
    <span style="color: #b6a0e0;">diff_fields</span>: <span style="color: #e0a0bc;">map</span>&lt;<span style="color: #9999bb;">sfs</span>, <span style="color: #F0DFAF; font-weight: bold;">any</span>&gt;;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Actually invokes the intentful function</span>
    <span style="color: #a7aac0;">invoke</span><span style="color: #BFEBBF;">()</span>: <span style="color: #a6bb99;">Response</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Diff-interface ends here</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org691ea36" class="outline-3">
<h3 id="h-EB9EEF16-2F6E-4F58-98AF-3846EC9E997D"><a id="org691ea36"></a><span class="section-number-3">4.4</span> Tasks</h3>
<div class="outline-text-3" id="text-h-EB9EEF16-2F6E-4F58-98AF-3846EC9E997D">
</div>
<div id="outline-container-org739341b" class="outline-4">
<h4 id="h-8C021415-DBCE-4114-8612-4E6459B0D1D4"><a id="org739341b"></a><span class="section-number-4">4.4.1</span> /src/tasks/task<sub>manager</sub><sub>interface.ts</sub></h4>
<div class="outline-text-4" id="text-h-8C021415-DBCE-4114-8612-4E6459B0D1D4">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-D04F146F-B16A-481B-9CD6-7552308467FF][task-manager-interface]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Task_Manager</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #a7aac0;">wait</span><span style="color: #BFEBBF;">()</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span>;
    <span style="color: #9999bb;">register_delta</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">Diff</span><span style="color: #D0BF8F;">[]</span><span style="color: #BFEBBF;">)</span>;
<span style="color: #DCDCCC;">}</span> 

<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">new_task</span> <span style="color: #DCDCCC;">()</span>: <span style="color: #a7aac0;">Task</span>;
<span style="color: #F0DFAF; font-weight: bold;">function</span> <span style="color: #93E0E3;">new_intentful_task</span> <span style="color: #DCDCCC;">(</span><span style="color: #DFAF8F;">papiea</span>: <span style="color: #DFAF8F;">Papiea</span>, <span style="color: #DFAF8F;">entity</span>: <span style="color: #DFAF8F;">Entity_Reference</span>, <span style="color: #DFAF8F;">kind</span>: <span style="color: #DFAF8F;">Kind</span>, <span style="color: #DFAF8F;">spec</span>: <span style="color: #DFAF8F;">Spec</span><span style="color: #DCDCCC;">)</span>: <span style="color: #a7aac0;">Task</span>;
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">task-manager-interface ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcdf28f7" class="outline-3">
<h3 id="h-9C85FED2-F254-40C5-A4BA-17F40E8C2358"><a id="orgcdf28f7"></a><span class="section-number-3">4.5</span> Provider SDK</h3>
<div class="outline-text-3" id="text-h-9C85FED2-F254-40C5-A4BA-17F40E8C2358">
</div>
<div id="outline-container-orgb3c811a" class="outline-4">
<h4 id="h-812BAEAD-238A-458B-AB66-C3E9AA93D621"><a id="orgb3c811a"></a><span class="section-number-4">4.5.1</span> Typescript: /src/provider<sub>sdk</sub>/typescript<sub>sdk</sub><sub>interface</sub></h4>
<div class="outline-text-4" id="text-h-812BAEAD-238A-458B-AB66-C3E9AA93D621">
<div class="org-src-container">
<pre class="src src-typescript"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-5256D1D9-391F-40C7-B090-EFC90473CDD0][provider_sdk_ts_provider_interface]]</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Api for the provider-sdk</span>
<span style="color: #F0DFAF; font-weight: bold;">enum</span> <span style="color: #7CB8BB;">Provider_Power</span> <span style="color: #DCDCCC;">{</span><span style="color: #b6a0e0;">On</span>, <span style="color: #b6a0e0;">Off</span>, <span style="color: #9999bb;">Suspended</span><span style="color: #DCDCCC;">}</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Provider</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #b3c0a7;">new_kind</span><span style="color: #BFEBBF;">(</span><span style="color: #a0d6e0;">entity_yaml</span>:<span style="color: #c0afa7;">Data_Description</span><span style="color: #BFEBBF;">)</span>:<span style="color: #99bbb4;">Kind</span>;
    <span style="color: #e0d0a0;">version</span><span style="color: #BFEBBF;">(</span><span style="color: #a7c0b9;">major</span>:<span style="color: #F0DFAF; font-weight: bold;">number</span>, <span style="color: #a6bb99;">minor</span>:<span style="color: #F0DFAF; font-weight: bold;">number</span>, <span style="color: #e0a0bc;">build</span>: <span style="color: #F0DFAF; font-weight: bold;">number</span>, <span style="color: #e0d0a0;">extra</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;
    <span style="color: #c0a7bd;">power</span><span style="color: #BFEBBF;">(</span><span style="color: #bb99b4;">state</span>: <span style="color: #a7aac0;">Provider_Power</span><span style="color: #BFEBBF;">)</span>: <span style="color: #a7aac0;">Provider_Power</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">provider_sdk_ts_provider_interface ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-5256D1D9-391F-40C7-B090-EFC90473CDD0][provider_sdk_ts_kind_interface]]</span>
<span style="color: #F0DFAF; font-weight: bold;">enum</span> <span style="color: #7CB8BB;">Procedural_Execution_Strategy</span> <span style="color: #DCDCCC;">{</span><span style="color: #99bbb4;">Halt_Intentful</span><span style="color: #DCDCCC;">}</span>;

<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Kind</span> <span style="color: #DCDCCC;">{</span>

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Adds an intentful handler. Dispatched based on the signautre passed</span>
    <span style="color: #e0a0bc;">on</span><span style="color: #BFEBBF;">(</span><span style="color: #a6bb99;">signature</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>, <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #bba699;">IntentfulCtx</span>, <span style="color: #bb99b4;">entity</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">void</span><span style="color: #BFEBBF;">)</span>:<span style="color: #e0a0bc;">Intentful_Handler</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Convenient functions for constructing/destructing an entity. Could be implemented in terms of "on above"</span>
    <span style="color: #9999bb;">on_new</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>, <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #bba699;">IntentfulCtx</span>, <span style="color: #bb99b4;">entity</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">void</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;
    <span style="color: #b3c0a7;">on_del</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>, <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #bba699;">IntentfulCtx</span>, <span style="color: #bb99b4;">entity</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">void</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;

    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Adds a procedural behaviour to the entity</span>
    <span style="color: #9999bb;">procedure</span><span style="color: #BFEBBF;">(</span><span style="color: #bba699;">name</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a7aac0;">rbac</span>: <span style="color: #F0DFAF; font-weight: bold;">any</span>,
              <span style="color: #9999bb;">strategy</span>: <span style="color: #99bbb4;">Procedural_Execution_Strategy</span>,
              <span style="color: #a0d6e0;">input_desc</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>,
              <span style="color: #bb99b4;">output_desc</span>: <span style="color: #F0DFAF; font-weight: bold;">string</span>,
              <span style="color: #a3e0a0;">handler</span>: <span style="color: #D0BF8F;">(</span><span style="color: #a7aac0;">ctx</span>:<span style="color: #9999bb;">ProceduralCtx</span>, <span style="color: #e0d0a0;">input</span>:<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #D0BF8F;">)</span>=&gt;<span style="color: #F0DFAF; font-weight: bold;">any</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;


    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Visualize all the intentful handlers and their priority</span>
    <span style="color: #a7aac0;">visualize_intentful_handlers</span><span style="color: #BFEBBF;">(</span><span style="color: #99bbb4;">filename</span>:<span style="color: #F0DFAF; font-weight: bold;">string</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">provider_sdk_ts_kind_interface ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-5256D1D9-391F-40C7-B090-EFC90473CDD0][provider_sdk_ts_intentful_handler_interface]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">Intentful_Handler</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Establishes a dependency tree between the various handlers</span>
    <span style="color: #c0afa7;">before</span><span style="color: #BFEBBF;">(</span>...<span style="color: #bb99b4;">handlers</span>: <span style="color: #e0a0bc;">Intentful_Handler</span><span style="color: #D0BF8F;">[]</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">void</span>;
<span style="color: #DCDCCC;">}</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">provider_sdk_ts_intentful_handler_interface ends here</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">[[file:~/work/papiea-js/Papiea-design.org::#h-5256D1D9-391F-40C7-B090-EFC90473CDD0][provider_sdk_ts_intentful_ctx_interface]]</span>
<span style="color: #F0DFAF; font-weight: bold;">interface</span> <span style="color: #7CB8BB;">IntentfulCtx</span> <span style="color: #DCDCCC;">{</span>
    <span style="color: #c0a7bd;">update_status</span><span style="color: #BFEBBF;">(</span><span style="color: #99bbb4;">metadata</span>: <span style="color: #b6a0e0;">Metadata</span>, <span style="color: #bba699;">status</span>: <span style="color: #9999bb;">Status</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
    <span style="color: #bba699;">update_progress</span><span style="color: #BFEBBF;">(</span><span style="color: #99bbb4;">message</span>:<span style="color: #F0DFAF; font-weight: bold;">string</span>, <span style="color: #a3e0a0;">done_percent</span>:<span style="color: #F0DFAF; font-weight: bold;">number</span><span style="color: #BFEBBF;">)</span>:<span style="color: #F0DFAF; font-weight: bold;">boolean</span>;
<span style="color: #DCDCCC;">}</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">For the time being these are equal. Later they may differ</span>
<span style="color: #F0DFAF; font-weight: bold;">type</span> <span style="color: #7CB8BB;">ProceduralCtx</span>=<span style="color: #bba699;">IntentfulCtx</span>;
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">provider_sdk_ts_intentful_ctx_interface ends here</span>
</pre>
</div>
</div>
</div>
</div>


<div id="outline-container-org5cb6dc2" class="outline-3">
<h3 id="h-DACB4BA2-5F6F-4327-B21C-1DC041186E62"><a id="org5cb6dc2"></a><span class="section-number-3">4.6</span> /src-go/papiea/engine/core.go</h3>
<div class="outline-text-3" id="text-h-DACB4BA2-5F6F-4327-B21C-1DC041186E62">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">All our structs and interfaces:</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Untyped json for now. We should probably use some better library for that:</span>
&lt;&lt;<span style="color: #a0d6e0;">untyped</span>-<span style="color: #bba699;">json</span>-<span style="color: #F0DFAF; font-weight: bold;">type</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Spec, status and metadata:</span>
&lt;&lt;<span style="color: #e0a0bc;">spec</span>-<span style="color: #F0DFAF; font-weight: bold;">struct</span>&gt;&gt;
&lt;&lt;<span style="color: #bba699;">status</span>-<span style="color: #F0DFAF; font-weight: bold;">struct</span>&gt;&gt;
&lt;&lt;<span style="color: #99bbb4;">metadata</span>-<span style="color: #F0DFAF; font-weight: bold;">struct</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Kind and providers:</span>
&lt;&lt;<span style="color: #a7c0b9;">kind</span>-<span style="color: #F0DFAF; font-weight: bold;">struct</span>&gt;&gt;
&lt;&lt;<span style="color: #e0d0a0;">provider</span>-<span style="color: #bba699;">desc</span>-<span style="color: #F0DFAF; font-weight: bold;">struct</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Define our database interfaces:</span>
&lt;&lt;<span style="color: #a7c0b9;">stataus</span>-<span style="color: #a0d6e0;">db</span>-<span style="color: #F0DFAF; font-weight: bold;">interface</span>&gt;&gt;
&lt;&lt;<span style="color: #e0a0bc;">spec</span>-<span style="color: #a0d6e0;">db</span>-<span style="color: #F0DFAF; font-weight: bold;">interface</span>&gt;&gt;
&lt;&lt;<span style="color: #bba699;">providers</span>-<span style="color: #a0d6e0;">db</span>-<span style="color: #F0DFAF; font-weight: bold;">interface</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Services interfaces:</span>
&lt;&lt;<span style="color: #e0a0bc;">task</span>-<span style="color: #F0DFAF; font-weight: bold;">interface</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Provider APIs signatures.</span>
<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Status Fields Signatures:</span>
&lt;&lt;<span style="color: #9999bb;">sfs</span>-<span style="color: #a6bb99;">signature</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Procedure Signatures:</span>
&lt;&lt;<span style="color: #9999bb;">procedure</span>-<span style="color: #a6bb99;">signature</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Provider handlers:</span>
&lt;&lt;<span style="color: #e0d0a0;">provider</span>-<span style="color: #a3e0a0;">handler</span>-<span style="color: #F0DFAF; font-weight: bold;">interface</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Papiea:</span>
&lt;&lt;<span style="color: #c0afa7;">initialize</span>-<span style="color: #a7c0b9;">papiea</span>&gt;&gt;
&lt;&lt;<span style="color: #99bbb4;">papiea_api_ctx</span>&gt;&gt;
&lt;&lt;<span style="color: #a7c0b9;">papiea_apis</span>&gt;&gt;

</pre>
</div>
</div>
</div>
<div id="outline-container-orge4004bf" class="outline-3">
<h3 id="h-00D3A0EA-DB73-4CED-8F7C-4EB3EAA376E9"><a id="orge4004bf"></a><span class="section-number-3">4.7</span> /src-go/papiea/engine/server.go</h3>
<div class="outline-text-3" id="text-h-00D3A0EA-DB73-4CED-8F7C-4EB3EAA376E9">
<div class="org-src-container">
<pre class="src src-go">#<span style="color: #F0DFAF; font-weight: bold;">import</span> <span style="color: #a7c0b9;">stuff</span>

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Initialize Papiea.</span>
&lt;&lt;<span style="color: #c0afa7;">initialize</span>-<span style="color: #a7c0b9;">papiea</span>-<span style="color: #c0afa7;">pc</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Admin Facing APIs:</span>
&lt;&lt;<span style="color: #bb99b4;">admin</span>-<span style="color: #a7aac0;">api</span>-<span style="color: #c0afa7;">pc</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Provider Facing APIS:</span>
&lt;&lt;<span style="color: #e0d0a0;">provider</span>-<span style="color: #a7aac0;">api</span>-<span style="color: #c0afa7;">pc</span>&gt;&gt;

<span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">User Facing APIs:</span>
&lt;&lt;<span style="color: #b3c0a7;">user</span>-<span style="color: #a7aac0;">api</span>-<span style="color: #c0afa7;">pc</span>&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-org2559501" class="outline-3">
<h3 id="h-E29103D3-EA85-42F9-BF93-145EEE1BF8E7"><a id="org2559501"></a><span class="section-number-3">4.8</span> /src-go/papiea/engine/provider.go</h3>
<div class="outline-text-3" id="text-h-E29103D3-EA85-42F9-BF93-145EEE1BF8E7">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Provider handler registration:</span>
&lt;&lt;<span style="color: #e0d0a0;">provider</span>-<span style="color: #a3e0a0;">handler</span>-<span style="color: #c0afa7;">pc</span>&gt;&gt;
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc57034f" class="outline-3">
<h3 id="h-9CA353DE-DC37-4567-B1F7-BEDA37B88D7A"><a id="orgc57034f"></a><span class="section-number-3">4.9</span> /src-go/papiea/engine/tasks.go</h3>
<div class="outline-text-3" id="text-h-9CA353DE-DC37-4567-B1F7-BEDA37B88D7A">
<div class="org-src-container">
<pre class="src src-go"><span style="color: #5F7F5F;">// </span><span style="color: #7F9F7F;">Provider handler registration:</span>
&lt;&lt;<span style="color: #e0a0bc;">task</span>-<span style="color: #c0afa7;">pc</span>&gt;&gt;
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org496a819" class="outline-2">
<h2 id="h-99185D18-042A-41E8-99D9-318CC64F397B"><a id="org496a819"></a><span class="section-number-2">5</span> Formalities</h2>
<div class="outline-text-2" id="text-h-99185D18-042A-41E8-99D9-318CC64F397B">
<p>
Handling resources at a large enough scale can become quite a tedious job. There are many loosly
connected moving parts that all strive to keep in sync. In reality this keeping in sync is an
assumption we cannot have, so we handle errors. Errors are tricky to maintain since recovering
from an error is defined by the context of the error. There are many techniques to approach error
handling, but for the problem of manipulating resources, we belive that an "Intentful Programming"
approach may be more suitable. 
</p>

<p>
The word "Intentful" could mean many things. One way would be to treat it as "Fulfilling a
desire". Why? because when you have a desire that needs fullfiling, every action that you make,
you make with the intent of solving the dissonance between what it is you actually have and what
it is you desire to have. 
</p>

<p>
This defintion is useful because we can draw some formalities out of it: 
</p>
<ol class="org-ol">
<li>Let \(T=\{(p,v)|p \in properties, v \in values\}\) be a representation of a state in our
world. For practical reasons, lets define it to be a set of properties and their values, which
collectively define the state.</li>
<li>Let \(cs \in T\) be a represention of "what it is we <b>actually have</b>"</li>
<li>Let \(ds \in T\) be a represention of "what it is we <b>desire to have</b>"</li>
<li>Let \(have=cs \setminus ds\) be all the things that we <b>have</b> and dont want</li>
<li>Let \(want=ds \setminus cs\) be all the things that we do <b>want</b></li>
<li>Let \(diff=\{(p, v_{old}, v_{new})|(p,v_{old})\in have, (p, v_{new})\in want\}\)</li>
</ol>

<p>
Now we know exactly which properties have to change, from what value and to what value, in order
to fulfil our desire. The next step is to define functions that can transform states. Lets develop
some intuition about how we approach fulfiling a desire:
</p>

<p>
Lets say that we are thirsty. This sensation is captured in a property. Lets say we also have a
cup, and that the cup property has the value "full". In that case, our resolving function would be
to drink from the cup. If the cup is not "full", we will have a brand new desire, to fill the
cup. We could do that with the "faucet" property, by setting its value to "open", which is yet
another desire. So lets model that:
</p>
<ol class="org-ol">
<li>\(properties={hydration, cup, faucet}\)</li>
<li>\(values=\{thirsty, quenched, full, empty, open, close\}\). Of course we could split this up so
properties may have values from close sets, but lets not get too rigorous for now.</li>
</ol>

<p>
Now lets define some functions:
</p>
<ol class="org-ol">
<li>\(drink:T \to T\)</li>
<li>\(faucet_{open}: T \to T\)</li>
<li>\(fillcup: T \to T\)</li>
<li>\(faucet_{close}: T \to T\)</li>
</ol>

<p>
At the end of applying any of the above function on \(cs\), we get a new, different \(cs\). We can
also get a new \(cs\) spontaniously, say magically the water got spilled from the cup or the faucet
broke. When \(cs\) changes for whatever reason, we recalculate \(diff\). Our goal is to have
\(|diff|=0\)
</p>

<p>
To make an action, we need to examine the different possibilities:
</p>
<ol class="org-ol">
<li>If \(\{(hydration, thirsty, quenched), (cup, _, full)\} \in diff\) then \(drink\)</li>
<li>If \(\{(hydration, thirsty, quenched), (cup, empty, full), (faucet, closed, open)\}\in diff\) then
\(faucet_{open}\)</li>
<li>If \(\{(hydration, thirsty, quenched), (cup, empty, full), (faucet, open, open)\}\in diff\) then \(fillcup\)</li>
<li>If \(\{(faucet, open, closed)\}\in diff\) then \(faucet_{close}\)</li>
</ol>

<p>
Lets generalize:
</p>
<ol class="org-ol">
<li>Let \(pred=\wp(diff)\), the power-set of \(diff\)</li>
<li>Lets assign to each function \(fn\) the set \(dispatch_{fn} \in pred\), which is the set such that
when it exists in \(pred\) this function \(fn\) is applied on \(cs\)</li>
</ol>

<p>
This last assignment is essentially establising a function dispatch mechanism on top of the \(diff\)
we managed to calculate from our representation of states in our world. The set assigned
identifies the action that needs to happen when either a new desire enters the system, or the
current status of the system changed without changing the desire. In our example, hydration
property of the current state was changed to "thirsty" while the desired state of "quenched" is
present. This system makes sure that we are never thirsty, given that we have a cup and a
faucet. We effectively not only fulfilled a desire, but also make sure it always stays fulfilled.
</p>

<p>
So the next step is what to do when there are a few desires simultaneously. How do we determine
what to do first? We could simply keep all our $dispatch<sub>fn</sub>$s in a list, ordered by our
perceived priorities. For example, do we first drink or do we first close the faucet?
</p>

<p>
Let \(dlist=(dispatch_{fn_1}, ..., dispatch_{fn_k})\), at every time we recalculate \(diff\), we
iterate through this ordered list one item at a time, see if \(dispatch_{fn_i} \subset diff\). If it is,
\({fn_i}\) is applied, \(cs\) and \(diff\) are recalculated, and we run thrugh \(dlist\) again from the top.
</p>
</div>
</div>

<div id="outline-container-orgde3c730" class="outline-2">
<h2 id="h-D503B966-E8E7-489B-836E-7B52758EE2E2"><a id="orgde3c730"></a><span class="section-number-2">6</span> Last notes</h2>
<div class="outline-text-2" id="text-h-D503B966-E8E7-489B-836E-7B52758EE2E2">
<ul class="org-ul">
<li>I followed <a href="http://ehneilsen.net/notebook/orgExamples/org-examples.html">this tutorial</a> for generating the source files through this org-mode.</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Shlomi Vaknin</p>
<p class="date">Created: 2018-12-05 Wed 23:35</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
